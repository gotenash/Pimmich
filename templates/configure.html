<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Configuration - Pimmich</title>
     <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <!-- GLightbox CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css" />
</head>
<body class="relative min-h-screen">

  <!-- Messages flash -->
  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div id="flash-container" class="relative z-10 max-w-xl mx-auto mt-4 space-y-2">
      {% for category, message in messages %}
        <div class="
          flash-message
          px-4 py-3 rounded-md text-white shadow-md transition-opacity duration-700 ease-in-out
          {% if category == 'success' %}
            bg-green-500
          {% elif category == 'error' %}
            bg-red-500
          {% elif category == 'warning' %}
            bg-yellow-400 text-black
          {% else %}
            bg-gray-500
          {% endif %}
        ">
          {{ message }}
        </div>
      {% endfor %}
    </div>
    
        <script>
      // Disparition automatique après 4 secondes
      setTimeout(() => {
        const messages = document.querySelectorAll('.flash-message');
        messages.forEach(msg => {
          msg.classList.add('opacity-0');
          setTimeout(() => msg.remove(), 700); // attendre que l'effet se termine
        });
      }, 4000);
    </script>
  {% endif %}
{% endwith %}

  <!-- Contenu principal -->
  <div class="relative z-10 container mx-auto p-4 bg-white/80 backdrop-blur-md rounded-xl shadow-xl mt-8">
    <img src="{{ url_for('static', filename='pimmich_logo.png') }}" alt="Logo Pimmich" class="logo mx-auto mb-4">
    <h2 class="text-center text-2xl font-semibold mb-4">Configuration du cadre photo connecté</h2>
        <div class="logout-link">
            <a href="/logout">Se déconnecter</a>
        </div>
        

<div class="tabs">
  <button class="tablink active" onclick="openTab(event, 'tab-affichage')">Affichage</button>
  <button class="tablink" onclick="openTab(event, 'tab-heure')">Heure</button>
  <button class="tablink" onclick="openTab(event, 'tab-sources')">Sources des photos</button>
  <button class="tablink" onclick="openTab(event, 'tab-apercu')">Aperçu</button>
  <button class="tablink" onclick="openTab(event, 'tab-actions')">Actions</button>
</div>

<form method="POST" action="/configure">

<div id="tab-affichage" class="tabcontent" style="display:block">
    <fieldset>
        <legend><h3>Paramètres d'affichage</h3></legend>

        <label for="display_duration">Durée d'affichage (en secondes) :</label>
        <input type="number" id="display_duration" name="display_duration" value="{{ config.display_duration }}" required>

        <label for="active_start">Heure de début d'activité (HH:MM) :</label>
        <input type="time" id="active_start" name="active_start" value="{{ config.active_start }}">

        <label for="active_end">Heure de fin d'activité (HH:MM) :</label>
        <input type="time" id="active_end" name="active_end" value="{{ config.active_end }}">

        <label for="screen_height_percent">Hauteur utile de l'écran (% affiché) :</label>
        <input type="number" id="screen_height_percent" name="screen_height_percent" min="10" max="100" value="{{ config.screen_height_percent }}">
    </fieldset>
</div>

 
                    
<div id="tab-heure" class="tabcontent">
    <fieldset>
        <legend><strong>Affichage de l'heure</strong></legend>

                    
                      <div style="margin-bottom: 8px;">
                        <label>
                          <input type="checkbox" name="show_clock" {% if config.get('show_clock', False) %}checked{% endif %}>
                          Afficher l'heure
                        </label>
                      </div>
                    
                      <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <label for="clock_font_size" style="min-width: 200px;">Taille de la police :</label>
                        <input type="number" name="clock_font_size" value="{{ config.get('clock_font_size', 48) }}">
                      </div>
                    
                      <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <label for="clock_offset_x" style="min-width: 200px;">Décalage horizontal (px) :</label>
                        <input type="number" name="clock_offset_x" value="{{ config.get('clock_offset_x', 30) }}">
                      </div>
                    
                      <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <label for="clock_offset_y" style="min-width: 200px;">Décalage vertical (px) :</label>
                        <input type="number" name="clock_offset_y" value="{{ config.get('clock_offset_y', 30) }}">
                      </div>
                    
                      <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <label for="clock_color" style="min-width: 200px;">Couleur du texte (hex) :</label>
                        <input type="text" name="clock_color" value="{{ config.get('clock_color', '#FFFFFF') }}">
                      </div>
                    
                      <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <label for="clock_outline_color" style="min-width: 200px;">Couleur du contour (hex) :</label>
                        <input type="text" name="clock_outline_color" value="{{ config.get('clock_outline_color', '#000000') }}">
                      </div>
                    
                      <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <label for="clock_position" style="min-width: 200px;">Position de l'heure :</label>
                        <select name="clock_position">
                          <option value="left" {% if config.get('clock_position') == 'left' %}selected{% endif %}>Gauche</option>
                          <option value="center" {% if config.get('clock_position') == 'center' %}selected{% endif %}>Centre</option>
                          <option value="right" {% if config.get('clock_position') == 'right' %}selected{% endif %}>Droite</option>
                        </select>
                      </div>
                    
                      <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <label for="clock_font_path" style="min-width: 200px;">Police :</label>
                        <select name="clock_font_path">
                          {% set fonts = [
                              ('/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf', 'DejaVu Sans Bold'),
                              ('/usr/share/fonts/truetype/liberation/LiberationSans-Regular.ttf', 'Liberation Sans'),
                              ('/usr/share/fonts/truetype/freefont/FreeSans.ttf', 'FreeSans')
                          ] %}
                          {% for path, label in fonts %}
                            <option value="{{ path }}" {% if config.get('clock_font_path') == path %}selected{% endif %}>{{ label }}</option>
                          {% endfor %}
                        </select>
                      </div>
           </fieldset>
</div>


<div id="tab-sources" class="tabcontent">
    <fieldset>
        <legend><h3>Configuration de l'album photo Immich</h3></legend>
                   

                        
                        <label for="album_name">Nom technique de l'album Immich :</label>
                        <input type="text" id="album_name" name="album_name" value="{{ config.album_name }}">


                        <label for="immich_url">URL du serveur Immich :</label>
                        <input type="url" id="immich_url" name="immich_url" value="{{ config.immich_url }}">

                        <label for="immich_token">Token d'accès Immich :</label>
                        <input type="text" id="immich_token" name="immich_token" value="{{ config.immich_token }}">




     </fieldset>
</div>

   
    <button type="submit" class="save-button">Enregistrer</button>

</form> 

<div id="tab-actions" class="tabcontent">
    <fieldset>
        <legend><h3>Actions</h3></legend>
                    <form method="POST" action="/toggle_slideshow">
                        <button type="submit">
                            {% if slideshow_running %} Arrêter{% else %} Démarrer{% endif %} le diaporama
                        </button>
                    </form>

                                       <button id="usb-import-btn" class="bg-rose-600 hover:bg-rose-700 text-white font-bold py-3 px-6 rounded-lg mt-6 shadow-lg transition duration-300 ease-in-out">Importer les photos depuis la clé USB
                                        </button>
                                        
                                        <div id="usb-progress-container" class="w-full bg-gray-300 rounded mt-4 h-6 overflow-hidden shadow-inner border border-gray-400 hidden">
                                            <div id="usb-progress-bar" 
                                                 class="h-full text-white text-center whitespace-nowrap transition-all duration-500 ease-in-out"
                                                 style="width: 0%; background: linear-gradient(90deg, #e11d48, #be123c); box-shadow: 0 0 10px #e11d48;">
                                              0%
                                            </div>
                                          </div>
                                        
                                        <div id="usb-import-status" class="mt-4 space-y-1 text-sm font-medium text-gray-700 max-h-48 overflow-y-auto"></div>



                                   <button id="immich-import-btn" class="bg-rose-600 hover:bg-rose-700 text-white font-bold py-2 px-4 rounded mt-4"> Importer les photos depuis Immich
                                    </button>
                                    
                                    <div id="immich-progress-container" class="w-full bg-gray-300 rounded mt-4 h-6 overflow-hidden shadow-inner border border-gray-400 hidden">
                                      <div id="immich-progress-bar"
                                           class="h-full text-white text-center whitespace-nowrap transition-all duration-500 ease-in-out"
                                           style="width: 0%; background: linear-gradient(90deg, #e11d48, #be123c); box-shadow: 0 0 10px #e11d48;">
                                        0%
                                      </div>
                                    </div>
                                    
                                    <div id="immich-import-status" class="mt-4 space-y-1 text-sm font-medium"></div>


                    <form method="POST" action="/reboot">
                        <button type="submit">Redémarrer le système</button>
                    </form>

                    <form method="POST" action="/shutdown">
                        <button type="submit">Éteindre le système</button>
                    </form>
  </fieldset>


  <fieldset>
                    <legend><h3>Crédits</h3></legend>
                    <div class="credits">
                        <img src="{{ url_for('static', filename='gotenash.jpg') }}" width="120">
                        <p>Auteurs : Gotenash et Shenron</p>
                        <a href="https://www.gadgetaulab.fr">
                            <img src="{{ url_for('static', filename='logo_gadgeto.png') }}" width="120">
                        </a>
                        <p>Projet réalisé dans le cadre du Gadgetaulab</p>
                    </div>
    </fieldset>
</div>
            
            
            
<div id="tab-apercu" class="tabcontent">
    {% if photos %}
    <fieldset class="photo-preview-section">
        <legend>Aperçu des photos préparées</legend>
        

            <div class="photo-grid">
                {% for photo in photos %}
                <div class="photo-tile">
                    <a href="{{ url_for('static', filename='prepared/' + photo) }}" class="glightbox" data-gallery="gallery1">
                      <img src="{{ url_for('static', filename='prepared/' + photo) }}" class="w-32 h-32 object-cover rounded shadow cursor-pointer hover:scale-105 transition">
                    </a>
                    <button class="delete-button" data-photo="{{ photo }}" title="Supprimer">✖</button>

                </div>
              
                {% endfor %}
            </div>
            
  </fieldset>
        {% endif %}
</div>  

<script src="https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js"></script>
<script>
  const lightbox = GLightbox({
    selector: '.glightbox'
  });
</script>
<script>

function openTab(evt, tabId) {
  const tabcontent = document.getElementsByClassName("tabcontent");
  const tablinks = document.getElementsByClassName("tablink");

  for (let i = 0; i < tabcontent.length; i++) {
    tabcontent[i].style.display = "none";
  }

  for (let i = 0; i < tablinks.length; i++) {
    tablinks[i].classList.remove("active");
  }

  document.getElementById(tabId).style.display = "block";
  evt.currentTarget.classList.add("active");
  
  // Sauvegarder l'onglet actuel dans le localStorage
  localStorage.setItem('activeTab', tabId);
}

// Restaurer l'onglet actif au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
  const activeTab = localStorage.getItem('activeTab');
  if (activeTab) {
    // Masquer tous les onglets
    const tabcontent = document.getElementsByClassName("tabcontent");
    const tablinks = document.getElementsByClassName("tablink");
    
    for (let i = 0; i < tabcontent.length; i++) {
      tabcontent[i].style.display = "none";
    }
    
    for (let i = 0; i < tablinks.length; i++) {
      tablinks[i].classList.remove("active");
    }
    
    // Afficher l'onglet sauvegardé
    const tabElement = document.getElementById(activeTab);
    const buttonElement = document.querySelector(`[onclick="openTab(event, '${activeTab}')"]`);
    
    if (tabElement && buttonElement) {
      tabElement.style.display = "block";
      buttonElement.classList.add("active");
    } else {
      // Fallback sur l'onglet par défaut si problème
      document.getElementById('tab-affichage').style.display = "block";
      document.querySelector('[onclick="openTab(event, \'tab-affichage\')"]').classList.add("active");
    }
  }
});

// Script de suppression amélioré
document.querySelectorAll('.delete-button').forEach(button => {
  button.addEventListener('click', async () => {
    const photo = button.dataset.photo;
    const confirmDelete = confirm(`Supprimer la photo ${photo} ?`);
    if (!confirmDelete) return;

    try {
      const response = await fetch(`/delete_photo/${photo}`, { method: 'DELETE' });
      
      if (response.ok) {
        // Suppression réussie - recharger la page
        // L'onglet actif sera automatiquement restauré grâce au localStorage
        location.reload();
      } else {
        alert("Erreur lors de la suppression.");
      }
    } catch (error) {
      console.error('Erreur:', error);
      alert("Erreur lors de la suppression.");
    }
  });
});
</script>

<script>

const lightbox = GLightbox({
    selector: '.glightbox',
    // Configuration pour forcer le centrage dans la zone visible
    onOpen: () => {
      // Scroll vers le haut de la zone d'aperçu quand la lightbox s'ouvre
      const tabApercu = document.getElementById('tab-apercu');
      if (tabApercu && tabApercu.style.display !== 'none') {
        // Calculer la position du tab aperçu
        const tabRect = tabApercu.getBoundingClientRect();
        const scrollOffset = window.pageYOffset + tabRect.top;
        
        // Scroll fluide vers le début de la zone aperçu
        window.scrollTo({
          top: Math.max(0, scrollOffset - 100), // -100px pour un peu d'espace
          behavior: 'smooth'
        });
      }
    },
    // Options de centrage
    plyr: {
      config: {
        youtube: { noCookie: true, rel: 0, showinfo: 0, iv_load_policy: 3 }
      }
    },
    // Centrage forcé
    beforeSlideLoad: (slide, data) => {
      // S'assurer que la lightbox apparaît dans la zone visible
      setTimeout(() => {
        const glightboxContainer = document.querySelector('.glightbox-container');
        if (glightboxContainer) {
          // Forcer le positionnement au centre de la zone visible actuelle
          glightboxContainer.style.position = 'fixed';
          glightboxContainer.style.top = '50%';
          glightboxContainer.style.left = '50%';
          glightboxContainer.style.transform = 'translate(-50%, -50%)';
          glightboxContainer.style.zIndex = '9999';
        }
      }, 10);
    }
  });
</script>

<!-- CSS additionnel pour améliorer le comportement -->
<style>
/* S'assurer que GLightbox reste centré dans la zone visible */
.glightbox-container {
  position: fixed !important;
  top: 50% !important;
  left: 50% !important;
  transform: translate(-50%, -50%) !important;
  z-index: 9999 !important;
}

/* Ajuster la grille pour une meilleure expérience */
.photo-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 1rem;
  padding: 1rem;
  max-height: 60vh; /* Limiter la hauteur de la grille */
  overflow-y: auto; /* Scroll si nécessaire */
}

.photo-tile {
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
}

/* Améliorer l'apparence du conteneur d'aperçu */
.photo-preview-section {
  max-height: 70vh;
  overflow-y: auto;
  border: 1px solid #e5e7eb;
  border-radius: 0.5rem;
  padding: 1rem;
}

/* Styles pour les messages de statut */
.status-message {
  padding: 0.5rem;
  margin: 0.25rem 0;
  border-radius: 0.375rem;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.status-success {
  background-color: #dcfce7;
  color: #166534;
  border-left: 4px solid #22c55e;
}

.status-error {
  background-color: #fef2f2;
  color: #dc2626;
  border-left: 4px solid #ef4444;
}

.status-warning {
  background-color: #fef3c7;
  color: #d97706;
  border-left: 4px solid #f59e0b;
}

.status-info {
  background-color: #eff6ff;
  color: #2563eb;
  border-left: 4px solid #3b82f6;
}
</style>

<script>
// Scripts d'import améliorés avec feedback détaillé
document.addEventListener("DOMContentLoaded", () => {
    
    function createStyledMessage(message, type = 'info') {
        const div = document.createElement('div');
        div.className = `status-message status-${type}`;
        div.textContent = message;
        return div;
    }

    function displayMessage(container, message) {
        let messageType = 'info';
        
        // Déterminer le type de message basé sur le contenu
        if (message.includes('Erreur') || message.toLowerCase().includes('error')) {
            messageType = 'error';
        } else if (message.includes('Terminé') || message.includes('Succès') || message.toLowerCase().includes('success')) {
            messageType = 'success';
        } else if (message.includes('Attention') || message.toLowerCase().includes('warning')) {
            messageType = 'warning';
        } else if (message.includes('Recherche') || message.includes('Téléchargement') || message.includes('Traitement')) {
            messageType = 'info';
        }
        
        const messageElement = createStyledMessage(message, messageType);
        container.appendChild(messageElement);
        container.scrollTop = container.scrollHeight;
    }

    // ----- IMPORT USB AMÉLIORÉ -----
    document.getElementById("usb-import-btn").addEventListener("click", () => {
        const btn = document.getElementById("usb-import-btn");
        const progressBar = document.getElementById("usb-progress-bar");
        const progressContainer = document.getElementById("usb-progress-container");
        const statusDiv = document.getElementById("usb-import-status");

        // Désactiver le bouton pendant l'import
        btn.disabled = true;
        btn.textContent = "Import en cours...";
        btn.classList.add("opacity-50", "cursor-not-allowed");

        // Reset de l'interface
        progressBar.style.width = "0%";
        progressBar.textContent = "0%";
        progressContainer.classList.remove("hidden");
        statusDiv.innerHTML = "";
        
        let importTermine = false;
        let timeoutId = null;

        const eventSource = new EventSource('/import-usb');

        eventSource.onmessage = (event) => {
            const line = event.data.trim();
            if (!line) return;

            // Annuler le timeout précédent
            if (timeoutId) {
                clearTimeout(timeoutId);
                timeoutId = null;
            }

            // Recherche du pourcentage dans le message
            const match = line.match(/^(\d+)%\s+(.*)/);
            if (match) {
                const percent = parseInt(match[1], 10);
                const message = match[2];

                progressBar.style.width = `${percent}%`;
                progressBar.textContent = `${percent}%`;
                
                displayMessage(statusDiv, line);

                if (percent >= 100 || message.includes("terminé") || message.includes("Terminé")) {
                    importTermine = true;
                    eventSource.close();
                    
                    // Réactiver le bouton après succès
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.textContent = "Importer les photos depuis la clé USB";
                        btn.classList.remove("opacity-50", "cursor-not-allowed");
                        
                        progressContainer.classList.add("hidden");
                        statusDiv.innerHTML = "";
                    }, 5000);
                }
            } else {
                displayMessage(statusDiv, line);
                
                // Vérifier les messages de fin sans pourcentage
                if (line.includes("terminé") || line.includes("Terminé")) {
                    importTermine = true;
                    eventSource.close();
                    
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.textContent = "Importer les photos depuis la clé USB";
                        btn.classList.remove("opacity-50", "cursor-not-allowed");
                        
                        progressContainer.classList.add("hidden");
                        statusDiv.innerHTML = "";
                    }, 5000);
                }
            }
        };

        eventSource.onerror = () => {
            eventSource.close();
            
            if (!importTermine) {
                displayMessage(statusDiv, "Erreur de connexion au serveur");
                
                setTimeout(() => {
                    btn.disabled = false;
                    btn.textContent = "Importer les photos depuis la clé USB";
                    btn.classList.remove("opacity-50", "cursor-not-allowed");
                    
                    progressContainer.classList.add("hidden");
                    statusDiv.innerHTML = "";
                }, 5000);
            }
        };
    });

    // ----- IMPORT IMMICH AMÉLIORÉ -----
    document.getElementById("immich-import-btn").addEventListener("click", () => {
        const btn = document.getElementById("immich-import-btn");
        const progressBar = document.getElementById("immich-progress-bar");
        const progressContainer = document.getElementById("immich-progress-container");
        const statusDiv = document.getElementById("immich-import-status");

        // Désactiver le bouton pendant l'import
        btn.disabled = true;
        btn.textContent = "Import en cours...";
        btn.classList.add("opacity-50", "cursor-not-allowed");

        // Reset de l'interface
        progressBar.style.width = "0%";
        progressBar.textContent = "0%";
        progressContainer.classList.remove("hidden");
        statusDiv.innerHTML = "";
        
        let importTermine = false;
        let timeoutId = null;

        const eventSource = new EventSource('/import-immich');

        eventSource.onmessage = (event) => {
            const line = event.data.trim();
            if (!line) return;

            // Annuler le timeout précédent
            if (timeoutId) {
                clearTimeout(timeoutId);
                timeoutId = null;
            }

            // Recherche du pourcentage dans le message
            const match = line.match(/^(\d+)%\s+(.*)/);
            if (match) {
                const percent = parseInt(match[1], 10);
                const message = match[2];

                progressBar.style.width = `${percent}%`;
                progressBar.textContent = `${percent}%`;
                
                displayMessage(statusDiv, line);

                if (percent >= 100 || message.includes("terminé") || message.includes("Terminé")) {
                    importTermine = true;
                    eventSource.close();
                    
                    // Réactiver le bouton après succès
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.textContent = "Importer les photos depuis Immich";
                        btn.classList.remove("opacity-50", "cursor-not-allowed");
                        
                        progressContainer.classList.add("hidden");
                        statusDiv.innerHTML = "";
                    }, 5000);
                }
            } else {
                displayMessage(statusDiv, line);
                
                // Vérifier les messages de fin sans pourcentage
                if (line.includes("terminé") || line.includes("Terminé")) {
                    importTermine = true;
                    eventSource.close();
                    
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.textContent = "Importer les photos depuis Immich";
                        btn.classList.remove("opacity-50", "cursor-not-allowed");
                        
                        progressContainer.classList.add("hidden");
                        statusDiv.innerHTML = "";
                    }, 5000);
                }
            }
        };

        eventSource.onerror = () => {
            eventSource.close();
            
            if (!importTermine) {
                displayMessage(statusDiv, "Erreur de connexion au serveur");
                
                setTimeout(() => {
                    btn.disabled = false;
                    btn.textContent = "Importer les photos depuis Immich";
                    btn.classList.remove("opacity-50", "cursor-not-allowed");
                    
                    progressContainer.classList.add("hidden");
                    statusDiv.innerHTML = "";
                }, 5000);
            }
        };
    });
});
</script>

</body>
</html>

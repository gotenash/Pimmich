<!DOCTYPE html>
<html lang="{{ get_locale() }}">
<head>
    <meta charset="UTF-8">
    <title>{{ _('Configuration') }} - Pimmich</title>
     <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <!-- GLightbox CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css" />
    <!-- Font Awesome pour les icônes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body class="relative min-h-screen">

  <!-- Messages flash -->
  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div id="flash-container" class="relative z-10 max-w-xl mx-auto mt-4 space-y-2">
      {% for category, message in messages %}
        <div class="
          flash-message
          px-4 py-3 rounded-md text-white shadow-md transition-opacity duration-700 ease-in-out
          {% if category == 'success' %}
            bg-green-500
          {% elif category == 'error' %}
            bg-red-500
          {% elif category == 'warning' %}
            bg-yellow-400 text-black
          {% else %}
            bg-gray-500
          {% endif %}
        ">
          {{ message }}
        </div>
      {% endfor %}
    </div>
    
        <script>
      // Disparition automatique après 4 secondes
      setTimeout(() => {
        const messages = document.querySelectorAll('.flash-message');
        messages.forEach(msg => {
          msg.classList.add('opacity-0');
          setTimeout(() => msg.remove(), 700); // attendre que l'effet se termine
        });
      }, 4000);
    </script>
  {% endif %}
{% endwith %}

  <!-- Contenu principal -->
  <div class="relative z-10 container mx-auto p-4 bg-white/80 backdrop-blur-md rounded-xl shadow-xl mt-8">
    <img src="{{ url_for('static', filename='pimmich_logo.png') }}" alt="Logo Pimmich" class="logo mx-auto mb-4">
    <h2 class="text-center text-2xl font-semibold mb-4">{{ _('Configuration du cadre photo connecté') }}</h2>
        <div class="flex justify-between items-center mb-4">
            <div class="language-selector text-sm">
                <span class="font-semibold">{{ _('Langue') }}:</span>
                {% set current_lang = get_locale() %}
                <a href="?lang=fr" class="{% if current_lang == 'fr' %}font-bold text-indigo-600{% else %}text-blue-600 hover:underline{% endif %}">FR</a> |
                <a href="?lang=en" class="{% if current_lang == 'en' %}font-bold text-indigo-600{% else %}text-blue-600 hover:underline{% endif %}">EN</a> |
                <a href="?lang=es" class="{% if current_lang == 'es' %}font-bold text-indigo-600{% else %}text-blue-600 hover:underline{% endif %}">ES</a>
            </div>
            <div class="logout-link">
                <a href="/logout">{{ _('Se déconnecter') }}</a>
            </div>
        </div>
        

<div class="tabs">
  <button class="tablink active" onclick="openTab(event, 'tab-affichage')">{{ _('Affichage') }}</button>
  <button class="tablink" onclick="openTab(event, 'tab-heure')">{{ _('Heure, Météo et Marées') }}</button>
  <button class="tablink" onclick="openTab(event, 'tab-sources')">{{ _('Sources des photos') }}</button>
  <button class="tablink" onclick="openTab(event, 'tab-apercu')">{{ _('Aperçu') }}</button>
  <button class="tablink" onclick="openTab(event, 'tab-favoris')">{{ _('Favoris') }} <span id="favorites-count-badge" class="hidden bg-yellow-400 text-white text-xs font-bold rounded-full h-5 w-5 inline-flex items-center justify-center ml-1">0</span></button>
  <button class="tablink" onclick="openTab(event, 'tab-actions')">{{ _('Actions') }}</button>
  <button class="tablink" onclick="openTab(event, 'tab-validation')">{{ _('Validation') }} <span id="pending-count-badge" class="hidden bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 inline-flex items-center justify-center ml-1">0</span></button>
  <button class="tablink" onclick="openTab(event, 'tab-system')">{{ _('Système') }}</button>
</div>

<form method="POST" action="/configure">

<div id="tab-affichage" class="tabcontent" style="display:block">
    <fieldset>
        <legend><h3>{{ _("Paramètres d'affichage") }}</h3></legend>

        <label for="display_duration">{{ _("Durée d'affichage (en secondes) :") }}</label>
        <input type="number" id="display_duration" name="display_duration" value="{{ config.display_duration }}" required>

        <label for="active_start">{{ _("Heure de début d'activité (HH:MM) :") }}</label>
        <input type="time" id="active_start" name="active_start" value="{{ config.active_start }}">

        <label for="active_end">{{ _("Heure de fin d'activité (HH:MM) :") }}</label>
        <input type="time" id="active_end" name="active_end" value="{{ config.active_end }}">

        <label for="screen_height_percent">{{ _("Hauteur utile de l'écran (%% affiché) :") }}</label>
        <input type="number" id="screen_height_percent" name="screen_height_percent" min="10" max="100" value="{{ config.screen_height_percent }}">

        <div class="flex items-center mt-2">
            <div class="flex-grow">
                <label for="display_width">{{ _("Largeur d'affichage cible (px) :") }}</label>
                <input type="number" id="display_width" name="display_width" value="{{ config.get('display_width', 1920) }}">
                <label for="display_height" class="mt-2">{{ _("Hauteur d'affichage cible (px) :") }}</label>
                <input type="number" id="display_height" name="display_height" value="{{ config.get('display_height', 1080) }}">
            </div>
            <button type="button" id="detect-resolution-btn" class="ml-4 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-3 rounded text-sm" title="{{ _('Détecter la résolution de l\'écran actif') }}">{{ _('Détecter') }}</button>
        </div>
        <div style="margin-top: 16px;">
            <label>
                <input type="checkbox" name="pan_zoom_enabled" {% if config.get('pan_zoom_enabled', False) %}checked{% endif %}>
                {{ _("Activer l'effet Pan/Zoom sur les photos") }}
            </label>
        </div>
        <div style="display: flex; align-items: center; margin-top: 8px;">
            <label for="pan_zoom_factor" style="min-width: 200px;">{{ _("Amplitude du zoom (ex: 1.15 pour 15%% de zoom) :") }}</label>
            <input type="number" step="0.01" id="pan_zoom_factor" name="pan_zoom_factor" value="{{ config.get('pan_zoom_factor', 1.15) }}">
        </div>
        <div style="margin-top: 16px;">
            <label>
                <input type="checkbox" name="transition_enabled" {% if config.get('transition_enabled', True) %}checked{% endif %}>
                {{ _("Activer l'effet de transition entre les photos") }}
            </label>
        </div>
        <div style="display: flex; align-items: center; margin-top: 8px;">
            <label for="transition_duration" style="min-width: 200px;">{{ _("Durée de transition (secondes) :") }}</label>
            <input type="number" step="0.1" id="transition_duration" name="transition_duration" value="{{ config.get('transition_duration', 1.0) }}">
        </div>
        <div style="display: flex; align-items: center; margin-top: 8px;">
            <label for="transition_type" style="min-width: 200px;">{{ _("Type de transition :") }}</label>
            <select name="transition_type" id="transition_type">
                <option value="fade" {% if config.get('transition_type') == 'fade' %}selected{% endif %}>{{ _('Fondu enchaîné') }}</option>
                <option value="slide_left" {% if config.get('transition_type') == 'slide_left' %}selected{% endif %}>{{ _('Glisser depuis la gauche') }}</option>
                <option value="slide_right" {% if config.get('transition_type') == 'slide_right' %}selected{% endif %}>{{ _('Glisser depuis la droite') }}</option>
                <option value="slide_up" {% if config.get('transition_type') == 'slide_up' %}selected{% endif %}>{{ _('Glisser depuis le bas') }}</option>
                <option value="slide_down" {% if config.get('transition_type') == 'slide_down' %}selected{% endif %}>{{ _('Glisser depuis le haut') }}</option>
            </select>
        </div>
        <div style="margin-top: 16px;">
            <label for="favorite_boost_factor">{{ _("Fréquence des favoris (nombre d'ajouts supplémentaires dans la liste de lecture) :") }}</label>
            <input type="number" id="favorite_boost_factor" name="favorite_boost_factor" value="{{ config.get('favorite_boost_factor', 2) }}" min="0">
            <p class="text-sm text-gray-600 mt-1">{{ _("Ex: 0 = pas de boost, 2 = 3x plus de chances d'apparaître.") }}</p>
        </div>
        <div style="margin-top: 16px;">
            <label>
                <input type="checkbox" id="video_audio_enabled" name="video_audio_enabled" {% if config.get('video_audio_enabled', False) %}checked{% endif %}>
                {{ _("Activer le son pour les vidéos") }}
            </label>
        </div>
        <div style="margin-top: 16px;">
            <label>
                <input type="checkbox" name="video_hwdec_enabled" {% if config.get('video_hwdec_enabled', False) %}checked{% endif %}>
                {{ _("Activer le décodage vidéo matériel (plus fluide, mais peut être instable)") }}
            </label>
            <p class="text-sm text-gray-600 mt-1">{{ _("Cochez cette case pour une lecture plus fluide sur les Raspberry Pi. Décochez si vous rencontrez des écrans bleus/noirs après les vidéos.") }}</p>
        </div>
        <div id="audio-output-selector" style="display: flex; align-items: center; margin-top: 8px; {% if not config.get('video_audio_enabled', False) %}display: none;{% endif %}">
            <label for="video_audio_output" style="min-width: 200px;">{{ _("Sortie audio :") }}</label>
            <select name="video_audio_output" id="video_audio_output">
                <option value="auto" {% if config.get('video_audio_output') == 'auto' %}selected{% endif %}>{{ _('Automatique') }}</option>
                <option value="hdmi" {% if config.get('video_audio_output') == 'hdmi' %}selected{% endif %}>{{ _('HDMI') }}</option>
                <option value="jack" {% if config.get('video_audio_output') == 'jack' %}selected{% endif %}>{{ _('Jack 3.5mm (Casque)') }}</option>
            </select>
        </div>
        <div id="audio-volume-selector" style="display: flex; align-items: center; margin-top: 8px; {% if not config.get('video_audio_enabled', False) %}display: none;{% endif %}">
            <label for="video_audio_volume" style="min-width: 200px;">{{ _("Volume :") }}</label>
            <input type="range" id="video_audio_volume_slider" min="0" max="100" value="{{ config.get('video_audio_volume', 100) }}" class="w-1/2">
            <input type="number" id="video_audio_volume" name="video_audio_volume" min="0" max="100" value="{{ config.get('video_audio_volume', 100) }}" class="w-16 ml-2 text-center">
            <span class="ml-1">%</span>
        </div>
    </fieldset>
</div>

                    
<div id="tab-heure" class="tabcontent">
    <fieldset>
        <legend><strong>{{ _("Affichage de l'heure") }}</strong></legend>

                    
                      <div style="margin-bottom: 8px;">
                        <label>
                          <input type="checkbox" name="show_clock" {% if config.get('show_clock', False) %}checked{% endif %}>
                          {{ _("Afficher l'heure") }}
                        </label>
                      </div>
                    
                      <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <label for="clock_font_size" style="min-width: 200px;">{{ _("Taille de la police :") }}</label>
                        <input type="number" name="clock_font_size" value="{{ config.get('clock_font_size', 48) }}">
                      </div>
                    
                      <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <label for="clock_offset_x" style="min-width: 200px;">{{ _("Décalage horizontal (px) :") }}</label>
                        <input type="number" name="clock_offset_x" value="{{ config.get('clock_offset_x', 30) }}">
                      </div>
                    
                      <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <label for="clock_offset_y" style="min-width: 200px;">{{ _("Décalage vertical (px) :") }}</label>
                        <input type="number" name="clock_offset_y" value="{{ config.get('clock_offset_y', 30) }}">
                      </div>
                    
                      <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <label for="clock_color" style="min-width: 200px;">{{ _("Couleur du texte (hex) :") }}</label>
                        <input type="text" name="clock_color" value="{{ config.get('clock_color', '#FFFFFF') }}">
                      </div>
                    
                      <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <label for="clock_outline_color" style="min-width: 200px;">{{ _("Couleur du contour (hex) :") }}</label>
                        <input type="text" name="clock_outline_color" value="{{ config.get('clock_outline_color', '#000000') }}">
                      </div>
                    
                      <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <label for="clock_position" style="min-width: 200px;">{{ _("Position de l'heure :") }}</label>
                        <select name="clock_position">
                          <option value="left" {% if config.get('clock_position') == 'left' %}selected{% endif %}>{{ _('Gauche') }}</option>
                          <option value="center" {% if config.get('clock_position') == 'center' %}selected{% endif %}>{{ _('Centre') }}</option>
                          <option value="right" {% if config.get('clock_position') == 'right' %}selected{% endif %}>{{ _('Droite') }}</option>
                        </select>
                      </div>
                    
                      <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <label for="clock_font_path" style="min-width: 200px;">{{ _("Police :") }}</label>
                        <select name="clock_font_path">
                          {% set fonts = [
                              ('/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf', 'DejaVu Sans Bold'),
                              ('/usr/share/fonts/truetype/liberation/LiberationSans-Regular.ttf', 'Liberation Sans'),
                              ('/usr/share/fonts/truetype/freefont/FreeSans.ttf', 'FreeSans')
                          ] %}
                          {% for path, label in fonts %}
                            <option value="{{ path }}" {% if config.get('clock_font_path') == path %}selected{% endif %}>{{ label }}</option>
                          {% endfor %}
                        </select>
                      </div>
                      <div style="margin-bottom: 8px;">
                        <label>
                          <input type="checkbox" name="clock_background_enabled" {% if config.get('clock_background_enabled', False) %}checked{% endif %}>
                          {{ _("Afficher un fond derrière l'heure/date/météo") }}
                        </label>
                      </div>
                      <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <label for="clock_background_color" style="min-width: 200px;">{{ _("Couleur du fond (hex RGBA) :") }}</label>
                        <input type="text" name="clock_background_color" value="{{ config.get('clock_background_color', '#00000080') }}">
                      </div>
    </fieldset>

    <fieldset class="mt-6">
        <legend><strong>{{ _("Affichage de la date") }}</strong></legend>
        <div style="margin-bottom: 8px;">
            <label>
                <input type="checkbox" name="show_date" {% if config.get('show_date', False) %}checked{% endif %}>
                {{ _("Afficher la date (sous l'heure)") }}
            </label>
        </div>
        <div style="display: flex; align-items: center; margin-bottom: 8px;">
            <label for="date_format" style="min-width: 200px;">{{ _("Format de la date :") }}</label>
            <input type="text" name="date_format" value="{{ config.get('date_format', '%A %d %B %Y') }}">
        </div>
    </fieldset>

    <fieldset class="mt-6">
        <legend><strong>{{ _("Affichage de la météo (OpenWeatherMap)") }}</strong></legend>

        <div style="margin-bottom: 8px;">
            <label>
                <input type="checkbox" name="show_weather" {% if config.get('show_weather', False) %}checked{% endif %}>
                {{ _("Afficher la météo") }}
            </label>
        </div>

        <div style="display: flex; align-items: center; margin-bottom: 8px;">
            <label for="weather_city" style="min-width: 200px;">{{ _("Ville :") }}</label>
            <input type="text" id="weather_city" name="weather_city" value="{{ config.get('weather_city', 'Paris') }}">
        </div>

        <div style="display: flex; align-items: center; margin-bottom: 8px;">
            <label for="weather_api_key" style="min-width: 200px;">{{ _("Clé API :") }}</label>
            <input type="text" id="weather_api_key" name="weather_api_key" value="{{ config.get('weather_api_key', '') }}">
        </div>
        
        <div class="mt-2 mb-4">
            <button type="button" id="testWeatherApiKeyBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded text-sm">{{ _("Tester la clé API et la ville") }}</button>
            <span id="weatherApiTestResult" class="ml-4 font-medium"></span>
        </div>

        <div style="display: flex; align-items: center; margin-bottom: 8px;">
            <label for="weather_units" style="min-width: 200px;">{{ _("Unités :") }}</label>
            <select name="weather_units" id="weather_units">
                <option value="metric" {% if config.get('weather_units') == 'metric' %}selected{% endif %}>{{ _('Celsius') }}</option>
                <option value="imperial" {% if config.get('weather_units') == 'imperial' %}selected{% endif %}>{{ _('Fahrenheit') }}</option>
            </select>
        </div>

        <div style="display: flex; align-items: center; margin-bottom: 8px;">
            <label for="weather_update_interval_minutes" style="min-width: 200px;">{{ _("Intervalle de MàJ (min) :") }}</label>
            <input type="number" name="weather_update_interval_minutes" value="{{ config.get('weather_update_interval_minutes', 30) }}">
        </div>
    </fieldset>

    <fieldset class="mt-6">
        <legend><strong>{{ _("Affichage des marées (StormGlass Tide API)") }}</strong></legend>
        <p class="text-sm text-gray-600 mb-3">{{ _("Utilise l'API de") }} <a href="https://stormglass.io/" target="_blank" class="text-blue-600 hover:underline">StormGlass</a>. {{ _("Une clé API est requise. Vous pouvez trouver les coordonnées de votre port sur des sites comme") }} <a href="https://www.latlong.net/" target="_blank" class="text-blue-600 hover:underline">latlong.net</a>.</p>
        <p class="text-sm text-gray-600 mb-3">{{ _("Note : Cette API fournit les hauteurs de marée, mais pas le coefficient de marée.") }}</p>

        <div style="margin-bottom: 8px;">
            <label>
                <input type="checkbox" name="show_tides" {% if config.get('show_tides', False) %}checked{% endif %}>
                {{ _("Afficher les informations de marée") }}
            </label>
        </div>

        <div style="display: flex; align-items: center; margin-bottom: 8px;">
            <label for="tide_latitude" style="min-width: 200px;">{{ _("Latitude (ex: 48.3904) :") }}</label>
            <input type="text" id="tide_latitude" name="tide_latitude" value="{{ config.get('tide_latitude', '') }}">
        </div>

        <div style="display: flex; align-items: center; margin-bottom: 8px;">
            <label for="tide_longitude" style="min-width: 200px;">{{ _("Longitude (ex: -4.4861) :") }}</label>
            <input type="text" id="tide_longitude" name="tide_longitude" value="{{ config.get('tide_longitude', '') }}">
        </div>

        <div style="display: flex; align-items: center; margin-bottom: 8px;">
            <label for="stormglass_api_key" style="min-width: 200px;">{{ _("Clé API StormGlass :") }}</label>
            <input type="text" id="stormglass_api_key" name="stormglass_api_key" value="{{ config.get('stormglass_api_key', '') }}">
        </div>

        <div style="display: flex; align-items: center; margin-bottom: 8px;">
            <label for="tide_offset_x" style="min-width: 200px;">{{ _("Décalage horizontal (px) :") }}</label>
            <input type="number" id="tide_offset_x" name="tide_offset_x" value="{{ config.get('tide_offset_x', 0) }}">
        </div>

        <div style="display: flex; align-items: center; margin-bottom: 8px;">
            <label for="tide_offset_y" style="min-width: 200px;">{{ _("Décalage vertical (px) :") }}</label>
            <input type="number" id="tide_offset_y" name="tide_offset_y" value="{{ config.get('tide_offset_y', 0) }}">
        </div>

        <div class="mt-2 mb-4">
            <button type="button" id="testStormglassApiKeyBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded text-sm inline-flex items-center"><i class="fas fa-plug mr-2"></i>{{ _("Tester la connexion") }}</button>
            <button type="button" id="forceTideUpdateBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded text-sm inline-flex items-center"><i class="fas fa-sync-alt mr-2"></i>{{ _("Forcer la mise à jour") }}</button>
        </div>
        <div class="mb-4">
            <span id="stormglassApiTestResult" class="ml-4 font-medium"></span>
            <span id="forceTideUpdateResult" class="ml-4 font-medium"></span>
        </div>

        <fieldset class="mt-6">
            <legend><strong>{{ _("État Actuel des Marées") }}</strong></legend>
            <div id="tide-status-container" class="p-3 bg-gray-100 rounded-lg border text-sm">
                <p><strong>{{ _("Dernière mise à jour des données :") }}</strong> <span id="tide-last-update" class="font-mono">{{ _("Chargement...") }}</span></p>
                <p><strong>{{ _("Prochaine Pleine Mer :") }}</strong> <span id="tide-next-high" class="font-mono">{{ _("Chargement...") }}</span></p>
                <p><strong>{{ _("Prochaine Basse Mer :") }}</strong> <span id="tide-next-low" class="font-mono">{{ _("Chargement...") }}</span></p>
                <p><strong>{{ _("État de l'API :") }}</strong> <span id="tide-api-status" class="font-mono text-gray-500">{{ _("Chargement...") }}</span></p>
            </div>
        </fieldset>
    </fieldset>

    <fieldset class="mt-6">
        <legend><strong>{{ _("Fuseau Horaire") }}</strong></legend>
        <div class="p-3 bg-gray-100 rounded-lg border">
            <p><strong>{{ _("Fuseau horaire actuel du système :") }}</strong> <span class="font-mono">{{ config.get('timezone', _('Non défini')) }}</span></p>
            {% if config.get('timezone_source') == 'fallback' %}
            <div class="mt-2 p-3 text-sm text-yellow-800 bg-yellow-100 rounded-lg" role="alert">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                <strong>{{ _("Attention :") }}</strong> {{ _("La détection automatique du fuseau horaire a échoué lors de l'installation. Le système est configuré sur <strong>UTC</strong>. L'heure affichée peut être incorrecte.")|safe }}
                <br>
                {{ _("Vous pouvez le corriger manuellement en vous connectant au Raspberry Pi (via SSH) et en exécutant la commande :") }} <code class="bg-gray-200 text-black p-1 rounded text-xs">sudo timedatectl set-timezone Europe/Paris</code> {{ _("(remplacez par votre région/ville).") }}
            </div>
            {% else %}
            <p class="text-sm text-gray-600 mt-1">{{ _("Le fuseau horaire a été configuré automatiquement lors de l'installation.") }}</p>
            {% endif %}
        </div>
    </fieldset>
</div>


<div id="tab-sources" class="tabcontent">
    <fieldset>
        <legend><h3>{{ _("Configuration de l'album photo Immich") }}</h3></legend>
                   

                        
                        <label for="album_name">{{ _("Nom technique de l'album Immich :") }}</label>
                        <input type="text" id="album_name" name="album_name" value="{{ config.album_name }}">


                        <label for="immich_url">{{ _("URL du serveur Immich :") }}</label>
                        <input type="url" id="immich_url" name="immich_url" value="{{ config.immich_url }}">

                        <label for="immich_token">{{ _("Token d'accès Immich :") }}</label>
                        <input type="text" id="immich_token" name="immich_token" value="{{ config.immich_token }}">

                        <hr class="my-4">
                        <h5 class="text-lg font-semibold mt-2">{{ _("Mise à jour automatique (Immich)") }}</h5>
                        <div class="form-check form-switch my-3">
                            <input class="form-check-input" type="checkbox" id="immich_auto_update" name="immich_auto_update" {% if config.get('immich_auto_update') %}checked{% endif %}>
                            <label class="form-check-label" for="immich_auto_update">{{ _("Activer la mise à jour automatique") }}</label>
                        </div>
                        <label for="immich_update_interval_hours">{{ _("Intervalle de mise à jour (heures):") }}</label>
                        <input type="number" id="immich_update_interval_hours" name="immich_update_interval_hours" value="{{ config.get('immich_update_interval_hours', 24) }}" min="1">

                        <div id="immich-worker-status-container" class="mt-4 p-3 bg-gray-100 rounded-lg border">
                            <p><strong>{{ _("État du service :") }}</strong> <span id="immich-worker-status-message" class="font-mono">...</span></p>
                            <p><strong>{{ _("Dernière mise à jour :") }}</strong> <span id="immich-last-update-time" class="font-mono">...</span></p>
                            <p><strong>{{ _("Prochaine mise à jour :") }}</strong> <span id="immich-next-update-time" class="font-mono">...</span></p>
                        </div>


    </fieldset>

    <fieldset class="mt-4">
        <legend><h3>{{ _("Sources à afficher dans le diaporama") }}</h3></legend>
        <p class="mb-3 text-gray-700">{{ _("Sélectionnez les sources de photos à inclure dans le diaporama. Les photos seront mélangées entre les sources sélectionnées.") }}</p>

        <div class="form-check form-switch my-2">
            <input class="form-check-input" type="checkbox" id="display_source_immich" name="display_sources" value="immich" {% if 'immich' in config.display_sources %}checked{% endif %}>
            <label class="form-check-label" for="display_source_immich">{{ _("Photos Immich") }}</label>
        </div>
        <div class="form-check form-switch my-2">
            <input class="form-check-input" type="checkbox" id="display_source_usb" name="display_sources" value="usb" {% if 'usb' in config.display_sources %}checked{% endif %}>
            <label class="form-check-label" for="display_source_usb">{{ _("Photos USB") }}</label>
        </div>
        <div class="form-check form-switch my-2">
            <input class="form-check-input" type="checkbox" id="display_source_samba" name="display_sources" value="samba" {% if 'samba' in config.display_sources %}checked{% endif %}>
            <label class="form-check-label" for="display_source_samba">{{ _("Photos Samba") }}</label>
        </div>
        <div class="form-check form-switch my-2">
            <input class="form-check-input" type="checkbox" id="display_source_smartphone" name="display_sources" value="smartphone" {% if 'smartphone' in config.display_sources %}checked{% endif %}>
            <label class="form-check-label" for="display_source_smartphone">{{ _("Photos Smartphone") }}</label>
        </div>
    </fieldset>
    <fieldset class="mt-4">
        <legend><h3>{{ _("Configuration du partage Samba (Windows)") }}</h3></legend>
        <label for="smb_host">{{ _("Serveur :") }}</label>
        <input type="text" id="smb_host" name="smb_host" value="{{ config.get('smb_host', '') }}" placeholder="{{ _('ex: 192.168.1.50 ou MON-NAS') }}">

        <label for="smb_share">{{ _("Nom du partage :") }}</label>
        <input type="text" id="smb_share" name="smb_share" value="{{ config.get('smb_share', '') }}" placeholder="{{ _('ex: Photos') }}">

        <label for="smb_path">{{ _("Chemin dans le partage (optionnel) :") }}</label>
        <input type="text" id="smb_path" name="smb_path" value="{{ config.get('smb_path', '') }}" placeholder="{{ _('ex: Famille/2024') }}">

        <label for="smb_user">{{ _("Nom d'utilisateur (optionnel) :") }}</label>
        <input type="text" id="smb_user" name="smb_user" value="{{ config.get('smb_user', '') }}">

        <label for="smb_password">{{ _("Mot de passe (optionnel) :") }}</label>
        <input type="password" id="smb_password" name="smb_password" value="{{ config.get('smb_password', '') }}">

        <div class="mt-4">
            <button type="button" id="samba-test-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">{{ _("Tester la connexion") }}</button>
            <span id="samba-test-status" class="ml-4 font-medium"></span>
        </div>

        <hr class="my-4">
        <h5 class="text-lg font-semibold mt-2">{{ _("Mise à jour automatique (Samba)") }}</h5>
        <div class="form-check form-switch my-3">
            <input class="form-check-input" type="checkbox" id="smb_auto_update" name="smb_auto_update" {% if config.get('smb_auto_update') %}checked{% endif %}>
            <label class="form-check-label" for="smb_auto_update">{{ _("Activer la mise à jour automatique") }}</label>
        </div>
        <label for="smb_update_interval_hours">{{ _("Intervalle de mise à jour (heures):") }}</label>
        <input type="number" id="smb_update_interval_hours" name="smb_update_interval_hours" value="{{ config.get('smb_update_interval_hours', 24) }}" min="1">

        <div id="samba-worker-status-container" class="mt-4 p-3 bg-gray-100 rounded-lg border">
            <p><strong>{{ _("État du service :") }}</strong> <span id="samba-worker-status-message" class="font-mono">...</span></p>
            <p><strong>{{ _("Dernière mise à jour :") }}</strong> <span id="samba-last-update-time" class="font-mono">...</span></p>
            <p><strong>{{ _("Prochaine mise à jour :") }}</strong> <span id="samba-next-update-time" class="font-mono">...</span></p>
        </div>

    </fieldset>

    <fieldset class="mt-4">
        <legend><h3>{{ _("Options de démarrage") }}</h3></legend>
        <div class="form-check form-switch my-3">
            <input class="form-check-input" type="checkbox" id="skip_initial_auto_import" name="skip_initial_auto_import" {% if config.get('skip_initial_auto_import', False) %}checked{% endif %}>
            <label class="form-check-label" for="skip_initial_auto_import">{{ _("Ignorer le premier import automatique au démarrage") }}</label>
        </div>
        <p class="text-sm text-gray-600 mt-2">{{ _("Si cette option est cochée, les mises à jour automatiques (Immich, Samba) ne se lanceront pas immédiatement après un redémarrage du cadre, mais attendront le prochain cycle programmé.") }}</p>
    </fieldset>
</div>

   
    <button type="submit" id="save-changes-btn" class="save-button">{{ _("Enregistrer les modifications") }}</button>

</form>

<div id="tab-actions" class="tabcontent">
    <fieldset>
    <legend><h3>{{ _("Actions") }}</h3></legend>

        <div class="action-group">
            <h4>{{ _("Aperçu en direct") }}</h4>
            <div id="live-preview-container" class="mt-2 p-3 bg-gray-100 rounded-lg border text-center">
                <p id="live-preview-status" class="text-gray-500 italic">{{ _("Le diaporama est arrêté.") }}</p>
                <img id="live-preview-image" src="" alt="{{ _('Photo en cours') }}" class="hidden mt-2 mx-auto max-w-xs max-h-48 rounded shadow">
            </div>
        </div>

        <div class="action-group">
            <h4>{{ _("Gestion du diaporama") }}</h4>
            <form method="POST" action="/toggle_slideshow">
                <button type="submit" class="system-button {% if slideshow_running %}bg-red-500 hover:bg-red-700{% else %}bg-green-500 hover:bg-green-700{% endif %} text-white font-bold py-2 px-4 rounded">
                    {% if slideshow_running %}
                    <i class="fas fa-stop"></i> {{ _("Arrêter le diaporama") }}
                    {% else %}
                    <i class="fas fa-play"></i> {{ _("Démarrer le diaporama") }}
                    {% endif %}
                </button>
            </form>
        </div>

        <div class="action-group">
            <h4>{{ _("Importation des photos") }}</h4>
            <button id="usb-import-btn" class="import-button bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                <i class="fas fa-file-import"></i> {{ _("Importer depuis la clé USB") }}
            </button>
            <div id="usb-progress-container" class="progress-container hidden">
                <div id="usb-progress-bar" class="progress-bar"></div>
            </div>
            <div id="usb-import-status" class="status-messages"></div>

            <button id="immich-import-btn" class="import-button bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                <i class="fas fa-cloud-download-alt"></i> {{ _("Importer depuis Immich") }}
            </button>
            <div id="immich-progress-container" class="progress-container hidden">
                <div id="immich-progress-bar" class="progress-bar"></div>
            </div>
            <div id="immich-import-status" class="status-messages"></div>
                                        
            <button id="samba-import-btn" class="import-button bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                <i class="fas fa-network-wired"></i> {{ _("Importer depuis Samba") }}
            </button>
            <div id="samba-progress-container" class="progress-container hidden">
                <div id="samba-progress-bar" class="progress-bar"></div>
            </div>
            <div id="samba-import-status" class="status-messages"></div>

            <!-- Smartphone Upload Form -->
            <form id="smartphone-upload-form" enctype="multipart/form-data" class="mt-4 pt-4 border-t border-gray-200">
                <h5 class="text-lg font-semibold mb-2 flex items-center gap-2"><i class="fas fa-mobile-alt"></i> {{ _("Importer depuis un Smartphone") }}</h5>
                <p class="text-sm text-gray-600 mb-3">{{ _("Envoyez des photos directement depuis votre téléphone via le navigateur.") }}</p>
                <input type="file" name="photos" class="block w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 cursor-pointer focus:outline-none mb-3" multiple required>
                <button type="submit" id="import-smartphone-btn" class="import-button bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                    <i class="fas fa-upload"></i> {{ _("Envoyer les photos") }}
                </button>
            </form>
            <div id="smartphone-progress-container" class="progress-container hidden">
                <div id="smartphone-progress-bar" class="progress-bar"></div>
            </div>
            <div id="smartphone-import-status" class="status-messages"></div>
        </div>
  </fieldset>
</div>

<div id="tab-validation" class="tabcontent">
    <fieldset>
        <legend><h3>{{ _("Photos en attente de validation") }}</h3></legend>
        <div class="flex justify-between items-center mb-4">
            <p class="text-gray-600">{{ _("Approuvez ou rejetez les photos envoyées. Les photos approuvées seront ajoutées à la source \"Smartphone\".") }}</p>
            <button type="button" id="refresh-pending-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded inline-flex items-center"><i class="fas fa-sync-alt mr-2"></i>{{ _("Actualiser") }}</button>
        </div>
        <div id="pending-photos-grid" class="photo-grid">
            <!-- Les photos en attente seront chargées ici par JavaScript -->
        </div>
    </fieldset>
</div>

<style>
.action-group {
    margin-bottom: 20px;
}
.action-group h4 {
    font-size: 1.2em;
    margin-bottom: 10px;
    color: #555;
}
                                        
/* Styles pour les boutons d'import et de contrôle système */
.import-button, .system-button {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

/* Styles pour la barre de progression et les messages de statut */
.progress-container {
    width: 100%;
    background-color: #f3f4f6; /* Tailwind's gray-100 */
    border-radius: 0.5rem;
    margin-top: 0.75rem;
    height: 1.5rem;
    overflow: hidden;
    box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
    border: 1px solid #d1d5db; /* Tailwind's gray-300 */
}

.progress-bar {
    height: 100%;
    text-align: center;
    white-space: nowrap;
    transition: width 0.3s ease;
    color: white;
    font-weight: 500;
    background-image: linear-gradient(90deg, #a855f7, #6366f1); /* Indigo-400 et Indigo-500 */
    box-shadow: 0 0 5px rgba(107, 114, 142, 0.5); /* Ombre subtile */
}

.status-messages {
    margin-top: 0.75rem;
    max-height: 10rem;
    overflow-y: auto;
    font-size: 0.875rem;
    color: #6b7280; /* Tailwind's gray-500 */
}

</style>
            
            
            
<div id="tab-apercu" class="tabcontent">
    <fieldset>
        <legend><h3>{{ _("Aperçu des photos préparées") }}</h3></legend>
        <p class="text-gray-600 mb-4">{{ _("Voici les photos qui sont prêtes à être affichées par le diaporama, classées par source. Cliquez sur une photo pour l'agrandir.") }}</p>

        {% if prepared_photos_by_source and prepared_photos_by_source.values()|map('count')|sum > 0 %}
            {% for source_name, photos in prepared_photos_by_source.items() %}
                {% if photos %}
                <fieldset class="mb-6 p-4 border rounded-lg bg-gray-50/50">
                    <div class="flex justify-between items-center border-b pb-2 mb-4">
                        <h4 class="text-xl font-semibold text-gray-800">{{ source_name.capitalize() }}</h4>
                        <!-- Bouton pour supprimer tous les médias de la source -->
                        <button type="button" class="delete-all-btn bg-red-600 hover:bg-red-700 text-white text-xs font-semibold py-1 px-3 rounded inline-flex items-center" data-source="{{ source_name }}" title="{{ _('Supprimer toutes les photos de la source \'%(source)s\'', source=source_name) }}">
                            <i class="fas fa-trash-alt mr-2"></i>
                            <span>{{ _("Tout supprimer") }}</span>
                        </button>
                    </div>
                        <div class="photo-grid">
                            {% for media in photos %}
                            {% set photo_path = media.path %}
                            {% set has_polaroid = media.has_polaroid %}
                            {% set active_filter = media.active_filter %}
                            <div class="photo-tile relative">
                                <!-- Spinner Overlay -->
                                <div class="spinner-overlay hidden absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center rounded z-10">
                                    <i class="fas fa-spinner fa-spin text-white text-3xl"></i>
                                </div>
                                
                                {% set media_url = url_for('static', filename='prepared/' + media.path) %}
                                {% set thumb_url = '' %} {# Fallback to empty string #}

                                {% if media.type == 'image' %}
                                    {% set thumb_url = media_url %}
                                    {% if media.active_filter == 'polaroid' and media.has_polaroid %}
                                        {% set polaroid_filename = media.path.rsplit('.', 1)[0] + '_polaroid.jpg' %}
                                        {% set thumb_url = url_for('static', filename='prepared/' + polaroid_filename) %}
                                    {% endif %}
                                {% elif media.type == 'video' and media.thumbnail_path %}
                                    {% set thumb_url = url_for('static', filename='prepared/' + media.thumbnail_path) %}
                                {% endif %}

                                <a href="{{ media_url }}" class="glightbox" data-gallery="{{ source_name }}" title="{{ _('Aperçu de %(media)s', media=media.path) }}">
                                  <img src="{{ thumb_url }}" class="w-32 h-32 object-cover rounded shadow cursor-pointer hover:scale-105 transition bg-gray-200" alt="{{ _('Aperçu de %(media)s', media=media.path) }}">
                                  {% if media.type == 'video' %}
                                  <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-25 rounded">
                                      <i class="fas fa-play text-white text-3xl opacity-75"></i>
                                  </div>
                                  {% endif %}
                                </a>
                                <!-- Actions alignées avec "justify-between" pour pousser la poubelle à droite -->
                                {% if media.type == 'image' %}
                                <div class="photo-actions mt-1 flex items-center justify-between w-full gap-x-2">
                                    <select class="filter-select text-xs rounded border-gray-300 py-1" data-photo="{{ photo_path }}">
                                        <option value="none" {% if active_filter == 'none' %}selected{% endif %}>{{ _("Filtre...") }}</option>
                                        <option value="grayscale" {% if active_filter == 'grayscale' %}selected{% endif %}>{{ _("Noir & Blanc") }}</option>
                                        <option value="sepia" {% if active_filter == 'sepia' %}selected{% endif %}>{{ _("Sépia") }}</option>
                                        <option value="vignette" {% if active_filter == 'vignette' %}selected{% endif %}>{{ _("Vignette") }}</option>
                                        <option value="vintage" {% if active_filter == 'vintage' %}selected{% endif %}>{{ _("Vintage") }}</option>
                                        {% if has_polaroid %}
                                        <option value="polaroid" {% if active_filter == 'polaroid' %}selected{% endif %}>{{ _("Polaroid") }}</option>
                                        {% endif %}
                                        <option value="original" class="text-blue-600 font-semibold">{{ _("Original") }}</option>
                                    </select>
                                    <button type="button" class="favorite-btn text-gray-400 hover:text-yellow-400 text-xs rounded py-1 px-2 {% if media.is_favorite %}text-yellow-400{% endif %}" data-photo="{{ photo_path }}" title="{{ _('Mettre en favori') }}">
                                        <i class="fas fa-star"></i>
                                    </button>
                                    <button type="button" class="delete-button bg-gray-500 hover:bg-gray-600 text-white text-xs rounded py-1 px-2" data-photo="{{ photo_path }}" title="{{ _('Supprimer cette photo') }}"><i class="fas fa-trash-alt"></i></button>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                </fieldset>
                {% endif %}
            {% endfor %}
        {% else %}
            <p class="text-center text-gray-500 italic mt-4">{{ _("Aucune photo préparée n'a été trouvée. Veuillez en importer depuis l'onglet \"Actions\".") }}</p>
        {% endif %}
    </fieldset>
</div>

<div id="tab-favoris" class="tabcontent">
    <fieldset>
        <legend><h3>{{ _("Vos photos favorites") }}</h3></legend>
        <p class="text-gray-600 mb-4">{{ _("Voici toutes vos photos marquées comme favorites. Vous pouvez les gérer ici.") }}</p>

        {% if favorite_photos %}
            <div id="favorites-photo-grid" class="photo-grid">
                {% for media in favorite_photos %}
                    {% set photo_path = media.path %}
                    {% set has_polaroid = media.has_polaroid %}
                    {% set active_filter = media.active_filter %}
                    <div class="photo-tile relative" data-path="{{ photo_path }}">
                        <!-- Spinner Overlay -->
                        <div class="spinner-overlay hidden absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center rounded z-10">
                            <i class="fas fa-spinner fa-spin text-white text-3xl"></i>
                        </div>
                        
                        {% set media_url = url_for('static', filename='prepared/' + media.path) %}
                        {% set thumb_url = '' %}

                        {% if media.type == 'image' %}
                            {% set thumb_url = media_url %}
                            {% if media.active_filter == 'polaroid' and media.has_polaroid %}
                                {% set polaroid_filename = media.path.rsplit('.', 1)[0] + '_polaroid.jpg' %}
                                {% set thumb_url = url_for('static', filename='prepared/' + polaroid_filename) %}
                            {% endif %}
                        {% elif media.type == 'video' and media.thumbnail_path %}
                            {% set thumb_url = url_for('static', filename='prepared/' + media.thumbnail_path) %}
                        {% endif %}

                        <a href="{{ media_url }}" class="glightbox" data-gallery="favorites" title="{{ _('Aperçu de %(media)s', media=media.path) }}">
                          <img src="{{ thumb_url }}" class="w-32 h-32 object-cover rounded shadow cursor-pointer hover:scale-105 transition bg-gray-200" alt="{{ _('Aperçu de %(media)s', media=media.path) }}">
                          {% if media.type == 'video' %}
                          <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-25 rounded">
                              <i class="fas fa-play text-white text-3xl opacity-75"></i>
                          </div>
                          {% endif %}
                        </a>
                        {% if media.type == 'image' %}
                        <div class="photo-actions mt-1 flex items-center justify-between w-full gap-x-2">
                            <select class="filter-select text-xs rounded border-gray-300 py-1" data-photo="{{ photo_path }}">
                                <option value="none" {% if active_filter == 'none' %}selected{% endif %}>{{ _("Filtre...") }}</option>
                                <option value="grayscale" {% if active_filter == 'grayscale' %}selected{% endif %}>{{ _("Noir & Blanc") }}</option>
                                <option value="sepia" {% if active_filter == 'sepia' %}selected{% endif %}>{{ _("Sépia") }}</option>
                                <option value="vignette" {% if active_filter == 'vignette' %}selected{% endif %}>{{ _("Vignette") }}</option>
                                <option value="vintage" {% if active_filter == 'vintage' %}selected{% endif %}>{{ _("Vintage") }}</option>
                                {% if has_polaroid %}<option value="polaroid" {% if active_filter == 'polaroid' %}selected{% endif %}>{{ _("Polaroid") }}</option>{% endif %}
                                <option value="original" class="text-blue-600 font-semibold">{{ _("Original") }}</option>
                            </select>
                            <button type="button" class="favorite-btn text-gray-400 hover:text-yellow-400 text-xs rounded py-1 px-2 {% if media.is_favorite %}text-yellow-400{% endif %}" data-photo="{{ photo_path }}" title="{{ _('Mettre en favori') }}"><i class="fas fa-star"></i></button>
                            <button type="button" class="delete-button bg-gray-500 hover:bg-gray-600 text-white text-xs rounded py-1 px-2" data-photo="{{ photo_path }}" title="{{ _('Supprimer cette photo') }}"><i class="fas fa-trash-alt"></i></button>
                        </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p id="no-favorites-message" class="text-center text-gray-500 italic mt-4">{{ _("Vous n'avez aucune photo en favori pour le moment.") }}</p>
        {% endif %}
    </fieldset>
</div>

<div id="tab-system" class="tabcontent">
    <fieldset class="mb-6">
        <legend><h3>{{ _("État de la connexion Wi-Fi") }}</h3></legend>
        <div id="wifi-status-container" class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="p-3 bg-gray-100 rounded-lg border">
                <strong>{{ _("État:") }}</strong> <span id="wifi-connection-state" class="font-semibold">{{ _("Chargement...") }}</span>
            </div>
            <div class="p-3 bg-gray-100 rounded-lg border">
                <strong>{{ _("Réseau (SSID):") }}</strong> <span id="wifi-current-ssid">{{ _("Chargement...") }}</span>
            </div>
            <div class="p-3 bg-gray-100 rounded-lg border">
                <strong>{{ _("Adresse IP:") }}</strong> <span id="wifi-ip-address">{{ _("Chargement...") }}</span>
            </div>
        </div>
    </fieldset>
    <fieldset class="mt-6">
        <legend><h3>{{ _("Configuration Wi-Fi") }}</h3></legend>
        <p class="text-sm text-gray-600 mb-3">{{ _("La sélection du pays est obligatoire pour activer l'interface Wi-Fi et respecter les réglementations locales sur les fréquences radio.") }}</p>
        <form action="{{ url_for('save_wifi_settings') }}" method="post" id="wifi-config-form">
            <div class="mb-4">
                <label for="wifi_country" class="block text-sm font-medium text-gray-700">{{ _("Pays (pour la réglementation Wi-Fi)") }}</label>
                <select id="wifi_country" name="wifi_country" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    {% set countries = [('FR', _('France')), ('US', _('États-Unis')), ('GB', _('Royaume-Uni')), ('DE', _('Allemagne')), ('ES', _('Espagne')), ('CA', _('Canada')), ('BE', _('Belgique')), ('CH', _('Suisse'))] %}
                    {% for code, name in countries %}
                        <option value="{{ code }}" {% if config.get('wifi_country', 'FR') == code %}selected{% endif %}>{{ name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-4">
                <label for="wifi_ssid" class="block text-sm font-medium text-gray-700">{{ _("SSID (Nom du réseau)") }}</label>
                <input type="text" id="wifi_ssid" name="wifi_ssid" value="{{ config.get('wifi_ssid', '') }}" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </div>
            <div class="mb-4">
                <label for="wifi_password" class="block text-sm font-medium text-gray-700">{{ _("Mot de passe") }}</label>
                <input type="password" id="wifi_password" name="wifi_password" value="{{ config.get('wifi_password', '') }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                <p class="mt-2 text-sm text-gray-500">{{ _("Laissez vide si le réseau est ouvert.") }}</p>
            </div>
            <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded inline-flex items-center">
                <i class="fas fa-save mr-2"></i>{{ _("Appliquer les paramètres Wi-Fi") }}
            </button>
        </form>
        <p class="mt-3 text-xs text-gray-500">{{ _("Note : Après avoir appliqué les paramètres, la connexion peut prendre jusqu'à une minute. Si le statut de connexion ci-dessus ne passe pas à \"Connecté\", vérifiez le mot de passe puis essayez de redémarrer le système.") }}</p>
    </fieldset>

    <fieldset class="mt-6">
        <legend><h3>{{ _("Gestion des Interfaces Réseau") }}</h3></legend>
        <p class="text-sm text-gray-600 mb-3">{{ _("Si le Wi-Fi ne se connecte pas alors qu'un câble Ethernet est branché, c'est souvent un problème de priorité. Désactivez l'interface Ethernet pour forcer le système à utiliser exclusivement le Wi-Fi. Cette action redémarre le service réseau.") }}</p>
        
        <!-- Interface Ethernet (eth0) -->
        <div id="eth0-status-container" class="p-4 border rounded-lg bg-gray-50/50 flex items-center justify-between">
            <div>
                <h4 class="font-semibold text-gray-800">{{ _("Interface Filaire (eth0)") }}</h4>
                <p class="text-sm"><strong>{{ _("État:") }}</strong> <span id="eth0-state" class="font-mono">{{ _("Chargement...") }}</span></p>
                <p class="text-sm"><strong>{{ _("Adresse IP:") }}</strong> <span id="eth0-ip" class="font-mono">{{ _("Chargement...") }}</span></p>
            </div>
            <div>
                <button id="toggle-eth0-btn" class="system-button text-white font-bold py-2 px-4 rounded" disabled>{{ _("Chargement...") }}</button>
            </div>
        </div>
    </fieldset>

    <!-- Bloc de scan Wi-Fi -->
    <div class="mt-6 p-4 border rounded-lg bg-gray-50/50">
        <h4 class="text-xl font-semibold text-gray-800 mb-2">{{ _("Réseaux Wi-Fi à proximité") }}</h4>
        <p class="text-gray-600 mb-4">{{ _("Cliquez sur le bouton pour rechercher les réseaux Wi-Fi disponibles. Cliquer sur un réseau dans la liste remplira automatiquement le champ SSID ci-dessus.") }}</p>
        <button id="scan-wifi-btn" type="button" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded mb-3 inline-flex items-center">
            <i class="fas fa-wifi mr-2"></i>
            <span id="scan-wifi-btn-text">{{ _("Lancer le scan") }}</span>
        </button>
        <div id="wifi-scan-results" class="mt-4">
            <!-- Les résultats du scan apparaîtront ici -->
        </div>
    </div>

    <fieldset class="mt-6">
        <legend><h3>{{ _("Sécurité") }}</h3></legend>
        <form action="{{ url_for('change_password_route') }}" method="post" id="password-change-form">
            <h4 class="text-lg font-semibold text-gray-800 mb-2">{{ _("Changer le mot de passe de l'interface") }}</h4>
            <div class="mb-4">
                <label for="new_password" class="block text-sm font-medium text-gray-700">{{ _("Nouveau mot de passe") }}</label>
                <input type="password" id="new_password" name="new_password" required minlength="6" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="{{ _('6 caractères minimum') }}">
            </div>
            <div class="mb-4">
                <label for="confirm_password" class="block text-sm font-medium text-gray-700">{{ _("Confirmer le nouveau mot de passe") }}</label>
                <input type="password" id="confirm_password" name="confirm_password" required minlength="6" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                <p id="password-error" class="mt-2 text-sm text-red-600 hidden">{{ _("Les mots de passe ne correspondent pas.") }}</p>
            </div>
            <button type="submit" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded inline-flex items-center">
                <i class="fas fa-key mr-2"></i>{{ _("Changer le mot de passe") }}
            </button>
        </form>
    </fieldset>

    <fieldset class="mt-6">
        <legend><h3>{{ _("Sauvegarde et Restauration") }}</h3></legend>
        <p class="text-sm text-gray-600 mb-3">{{ _("Sauvegardez votre configuration (API, partages, affichage...) dans un fichier. Vous pourrez le restaurer plus tard ou sur une nouvelle installation.") }}</p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Sauvegarde -->
            <div class="p-4 border rounded-lg bg-gray-50/50">
                <h4 class="font-semibold text-gray-800 mb-2">{{ _("Sauvegarder la configuration") }}</h4>
                <a href="{{ url_for('backup_settings_api') }}" class="system-button bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded inline-flex items-center">
                    <i class="fas fa-download mr-2"></i>{{ _("Télécharger la sauvegarde") }}
                </a>
            </div>
            <!-- Restauration -->
            <div class="p-4 border rounded-lg bg-gray-50/50">
                <h4 class="font-semibold text-gray-800 mb-2">{{ _("Restaurer une configuration") }}</h4>
                <form action="{{ url_for('restore_settings_api') }}" method="post" enctype="multipart/form-data" onsubmit="return confirm('{{ _('Êtes-vous sûr ? La configuration actuelle sera écrasée par le contenu du fichier de sauvegarde.') }}')">
                    <input type="file" name="backup_file" accept=".json" required class="block w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 cursor-pointer focus:outline-none mb-3">
                    <button type="submit" class="system-button bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded inline-flex items-center"><i class="fas fa-upload mr-2"></i>{{ _("Restaurer") }}</button>
                </form>
            </div>
        </div>
    </fieldset>

    <fieldset class="mt-6">
        <legend><h3>{{ _("Contrôle du système") }}</h3></legend>
        <form method="POST" action="/reboot" onsubmit="return confirm('{{ _('Êtes-vous sûr de vouloir REDÉMARRER le système ?') }}');">
            <button type="submit" class="system-button bg-yellow-500 hover:bg-yellow-700 text-gray-800 font-bold py-2 px-4 rounded">
                <i class="fas fa-sync-alt"></i> {{ _("Redémarrer le système") }}
            </button>
        </form>
        <form method="POST" action="/shutdown" onsubmit="return confirm('{{ _('Êtes-vous sûr de vouloir ÉTEINDRE le système ?') }}');">
            <button type="submit" class="system-button bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                <i class="fas fa-power-off"></i> {{ _("Éteindre le système") }}
            </button>
        </form>
    </fieldset>

    <fieldset class="mt-6">
        <legend><h3>{{ _("Informations Système") }}</h3></legend>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="p-3 bg-gray-100 rounded-lg border">
                <strong>{{ _("Température CPU:") }}</strong> <span id="cpu-temp">{{ _("Chargement...") }}</span>
            </div>
            <div class="p-3 bg-gray-100 rounded-lg border">
                <strong>{{ _("Utilisation CPU:") }}</strong> <span id="cpu-usage">{{ _("Chargement...") }}</span>
            </div>
            <div class="p-3 bg-gray-100 rounded-lg border">
                <strong>{{ _("RAM:") }}</strong> <span id="ram-usage">{{ _("Chargement...") }}</span>
            </div>
            <div class="p-3 bg-gray-100 rounded-lg border">
                <strong>{{ _("Stockage:") }}</strong> <span id="disk-usage">{{ _("Chargement...") }}</span>
            </div>
        </div>
    </fieldset>

    <fieldset class="mt-6" style="min-width: 0;">
        <legend><h3>{{ _("Logs Système") }}</h3></legend>
        <div class="mb-3">
            <label for="log-selector" class="form-label">{{ _("Sélectionner un log :") }}</label>
            <select id="log-selector" class="form-select">
                <option value="app">{{ _("app.py (Serveur Web)") }}</option>
                <option value="slideshow_stdout">{{ _("local_slideshow.py (Diaporama - Sortie Standard)") }}</option>
                <option value="slideshow_stderr">{{ _("local_slideshow.py (Diaporama - Erreurs)") }}</option>
            </select>
            <button type="button" id="refresh-logs-btn" class="btn btn-secondary bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded ml-2">{{ _("Actualiser") }}</button>
            <button type="button" id="clear-logs-btn" class="btn btn-danger bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded ml-2">{{ _("Effacer les logs") }}</button>
        </div>
        <div class="bg-gray-800 rounded-lg overflow-auto" style="max-height: 400px;">
            <pre id="log-content" class="text-white p-4 text-sm" style="min-height: 150px; white-space: pre-wrap; word-break: break-all;"></pre>
        </div>
    </fieldset>

    <fieldset class="mt-6">
        <legend><h3>{{ _("Crédits") }}</h3></legend>
        <div class="credits">
            <img src="{{ url_for('static', filename='gotenash.jpg') }}" width="120" alt="Auteur Gotenash">
            <p>{{ _("Auteurs : Gotenash et Shenron") }}</p>
            <a href="https://www.gadgetaulab.fr">
                <img src="{{ url_for('static', filename='logo_gadgeto.png') }}" width="120" alt="Logo Gadgetaulab">
            </a>
            <p>{{ _("Projet réalisé dans le cadre du Gadgetaulab") }}</p>
        </div>
    </fieldset>
</div>

<script src="https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js"></script>
<script>
  const lightbox = GLightbox({
    selector: '.glightbox'
  });

  // Translations for JavaScript
  const i18n = {
    loading: "{{ _('Chargement...') }}",
    error: "{{ _('Erreur') }}",
    notAvailable: "{{ _('N/A') }}",
    scanInProgress: "{{ _('Scan en cours...') }}",
    startScan: "{{ _('Lancer le scan') }}",
    noNetworksFound: "{{ _('Aucun réseau Wi-Fi trouvé.') }}",
    commError: "{{ _('Erreur de communication avec le serveur:') }}",
    headerSSID: "{{ _('SSID') }}",
    headerSecurity: "{{ _('Sécurité') }}",
    headerSignal: "{{ _('Signal') }}",
    noSecurity: "{{ _('Aucune') }}",
    favoriteTooltip: "{{ _('Mettre en favori') }}",
    noFavorites: "{{ _("Vous n'avez aucune photo en favori pour le moment.") }}",
    selectNetworkTitle: "{{ _('Cliquer pour sélectionner ce réseau') }}"
  };

  // ----- GESTION DE LA VALIDATION (Fonctions globales) -----
  // On définit ces fonctions ici pour qu'elles soient accessibles partout et éviter les erreurs de chargement.

  async function refreshValidationTab() {
      const grid = document.getElementById('pending-photos-grid');
      const badge = document.getElementById('pending-count-badge');
      const validationTab = document.getElementById('tab-validation');
      const isTabActive = validationTab && validationTab.style.display === 'block';

      if (isTabActive && grid && !grid.hasChildNodes()) {
          grid.innerHTML = '<p class="text-center text-gray-500 italic">Chargement des photos en attente...</p>';
      }

      try {
          const response = await fetch(`/api/get_pending_photos?_=${new Date().getTime()}`);
          const data = await response.json();
          if (!data.success) throw new Error(data.message || "Erreur serveur");

          const photoCount = data.photos.length;

          if (badge) {
              if (photoCount > 0) {
                  badge.textContent = photoCount;
                  badge.classList.remove('hidden');
              } else {
                  badge.classList.add('hidden');
              }
          }

          if (isTabActive && grid) {
              if (photoCount === 0) {
                  grid.innerHTML = '<p class="text-center text-gray-500 italic">Aucune photo en attente de validation.</p>';
              } else {
                  grid.innerHTML = '';
                  data.photos.forEach(filename => {
                      const tile = document.createElement('div');
                      tile.className = 'photo-tile';
                      tile.dataset.filename = filename;
                      const imgSrc = `/static/pending_uploads/${filename}`;
                      tile.innerHTML = `
                          <a href="${imgSrc}" class="glightbox" data-gallery="pending" title="${filename}"><img src="${imgSrc}" class="w-32 h-32 object-cover rounded shadow"></a>
                          <div class="photo-actions mt-1 flex items-center justify-around w-full gap-x-2">
                              <button class="approve-btn bg-green-500 hover:bg-green-600 text-white text-xs rounded py-1 px-2" title="Approuver"><i class="fas fa-check"></i></button>
                              <button class="reject-btn bg-red-500 hover:bg-red-600 text-white text-xs rounded py-1 px-2" title="Rejeter"><i class="fas fa-times"></i></button>
                          </div>`;
                      grid.appendChild(tile);
                  });
                  GLightbox({ selector: '#pending-photos-grid .glightbox' });
              }
          }
      } catch (error) {
          if (isTabActive && grid) grid.innerHTML = `<p class="text-center text-red-500">Erreur: ${error.message}</p>`;
          if (badge) badge.classList.add('hidden');
      }
  }

  async function handlePendingAction(filename, action) {
      const tile = document.querySelector(`.photo-tile[data-filename="${filename}"]`);
      if (tile) tile.style.opacity = '0.5';

      try {
          const response = await fetch('/api/manage_pending_photo', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ filename, action })
          });
          const result = await response.json();
          if (result.success) refreshValidationTab();
          else { alert(`Erreur: ${result.message}`); if (tile) tile.style.opacity = '1'; }
      } catch (error) { alert("Erreur de communication."); if (tile) tile.style.opacity = '1'; }
  }
</script>
<script>

function openTab(evt, tabId) {
    // Si on clique sur l'onglet Favoris et qu'il n'est pas déjà actif, on recharge la page
    // pour s'assurer que la liste des favoris est à jour.
    const clickedButton = evt ? evt.currentTarget : null;
    if (tabId === 'tab-favoris' && clickedButton && !clickedButton.classList.contains('active')) {
        localStorage.setItem('activeTab', 'tab-favoris'); // On s'assure de revenir sur le bon onglet
        location.reload();
        return; // On arrête l'exécution pour laisser le rechargement se faire
    }

    const tabcontent = document.getElementsByClassName("tabcontent");
    const tablinks = document.getElementsByClassName("tablink");

    for (const tab of tabcontent) {
        tab.style.display = "none";
    }
    for (const link of tablinks) {
        link.classList.remove("active");
    }

    const tabElement = document.getElementById(tabId);
    if (tabElement) {
        tabElement.style.display = "block";
    }

    // Gérer la classe active sur le bouton de l'onglet
    const currentButton = evt ? evt.currentTarget : document.querySelector(`.tablink[onclick*="'${tabId}'"]`);
    if (currentButton) {
        currentButton.classList.add("active");
    }
    localStorage.setItem('activeTab', tabId);

    // Gérer la visibilité du bouton "Enregistrer"
    const saveButton = document.getElementById('save-changes-btn');
    const tabsWithoutSaveButton = ['tab-apercu', 'tab-actions', 'tab-system', 'tab-validation', 'tab-favoris'];
    if (tabId === 'tab-validation') {
        refreshValidationTab(); // On rafraîchit la grille et le badge
    }
    if (saveButton) {
        saveButton.style.display = tabsWithoutSaveButton.includes(tabId) ? 'none' : 'block';
    }

}

// Restaurer l'onglet actif au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    let activeTabId = localStorage.getItem('activeTab') || 'tab-affichage';
    if (!document.getElementById(activeTabId)) {
        activeTabId = 'tab-affichage';
    }
    openTab(null, activeTabId);

    // Mettre à jour le badge au chargement (et la grille si l'onglet est déjà actif)
    refreshValidationTab(); // Appel initial pour mettre à jour le badge
    setInterval(refreshValidationTab, 15000); // Et le mettre à jour périodiquement

    // Mettre à jour le badge des favoris
    const favoritesCount = {{ favorite_photos|length }};
    const favoritesBadge = document.getElementById('favorites-count-badge');
    if (favoritesBadge) {
        if (favoritesCount > 0) {
            favoritesBadge.textContent = favoritesCount;
            favoritesBadge.classList.remove('hidden');
        } else {
            favoritesBadge.classList.add('hidden');
        }
    }

    // Gérer l'affichage du sélecteur de sortie audio
    const audioEnabledCheckbox = document.getElementById('video_audio_enabled');
    const audioOutputSelector = document.getElementById('audio-output-selector');
    const audioVolumeSelector = document.getElementById('audio-volume-selector');
    if (audioEnabledCheckbox && audioOutputSelector && audioVolumeSelector) {
        audioEnabledCheckbox.addEventListener('change', function() {
            const displayStyle = this.checked ? 'flex' : 'none';
            audioOutputSelector.style.display = displayStyle;
            audioVolumeSelector.style.display = displayStyle;
        });
    }

    // Lier le slider et le champ numérique pour le volume
    const volumeSlider = document.getElementById('video_audio_volume_slider');
    const volumeNumber = document.getElementById('video_audio_volume');
    if (volumeSlider && volumeNumber) {
        volumeSlider.addEventListener('input', () => { volumeNumber.value = volumeSlider.value; });
        volumeNumber.addEventListener('input', () => { volumeSlider.value = volumeNumber.value; });
    }

    // --- Password validation ---
    const passwordForm = document.getElementById('password-change-form');
    if (passwordForm) {
        passwordForm.addEventListener('submit', function(event) {
            const newPassword = document.getElementById('new_password').value;
            const confirmPassword = document.getElementById('confirm_password').value;
            const errorP = document.getElementById('password-error');
            if (newPassword !== confirmPassword) {
                errorP.classList.remove('hidden');
                event.preventDefault(); // Stop form submission
            } else {
                errorP.classList.add('hidden');
            }
        });
    }
});

// Script de suppression amélioré
document.querySelectorAll('.delete-button').forEach(button => {
  button.addEventListener('click', async (event) => {
    const photo = button.dataset.photo;
    const confirmDelete = confirm(`Supprimer la photo ${photo} ?`);
    if (!confirmDelete) return;

    try {
      const response = await fetch(`/delete_photo/${photo}`, { method: 'DELETE' });
      
      if (response.ok) {
        // Suppression réussie - recharger la page
        // L'onglet actif sera automatiquement restauré grâce au localStorage
        location.reload();
      } else {
        alert("Erreur lors de la suppression.");
      }
    } catch (error) {
      console.error('Erreur:', error);
      alert("Erreur lors de la suppression.");
    }
  });
});

// Script pour supprimer toutes les photos d'une source
document.querySelectorAll('.delete-all-btn').forEach(button => {
    button.addEventListener('click', async (event) => {
        const source = button.dataset.source;
        const confirmDelete = confirm(`Êtes-vous sûr de vouloir supprimer TOUTES les photos de la source "${source}" ? Cette action est irréversible.`);
        if (!confirmDelete) return;

        try {
            const response = await fetch(`/delete_source_photos/${source}`, { method: 'DELETE' });
            
            if (response.ok) {
                // Recharger la page pour voir les changements
                location.reload();
            } else {
                const result = await response.json();
                alert(`Erreur lors de la suppression : ${result.message || 'Erreur inconnue'}`);
            }
        } catch (error) {
            console.error('Erreur:', error);
            alert("Erreur de communication lors de la suppression.");
        }
    });
});

// Script pour appliquer les filtres
document.querySelectorAll('.filter-select').forEach(select => {
    select.addEventListener('change', async (event) => {
        const filter = event.target.value;
        const photo = select.dataset.photo;

        const tileElement = select.closest('.photo-tile');
        if (!tileElement) return;

        const spinnerOverlay = tileElement.querySelector('.spinner-overlay');
        const imgElement = tileElement.querySelector('img');
        const glightboxLink = tileElement.querySelector('a.glightbox');

        // --- 1. Sauvegarder la préférence de filtre ---
        try {
            await fetch('/api/set_photo_filter', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ photo: photo, filter: filter })
            });
        } catch (e) {
            alert('Erreur lors de la sauvegarde de la préférence.');
            return;
        }

        // --- 2. Mettre à jour l'aperçu ---
        if (filter === 'none') {
            // Ne rien faire à l'aperçu si l'utilisateur sélectionne "Filtre..."
            // Pour réinitialiser, l'utilisateur doit choisir "Original".
            return;
        }

        if (filter === 'polaroid') {
            // Afficher instantanément la version pré-générée
            const polaroidPath = photo.replace('.jpg', '_polaroid.jpg');
            const newSrc = `/static/prepared/${polaroidPath}?v=${new Date().getTime()}`;
            imgElement.src = newSrc;
            if (glightboxLink) glightboxLink.href = newSrc;
        } else {
            // Pour les autres filtres (y compris 'original'), les appliquer en direct
            if (spinnerOverlay) spinnerOverlay.classList.remove('hidden');

            try {
                const response = await fetch('/api/apply_filter', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ photo: photo, filter: filter })
                });
                const result = await response.json();

                if (result.success) {
                    imgElement.onload = () => { if (spinnerOverlay) spinnerOverlay.classList.add('hidden'); imgElement.onload = null; };
                    imgElement.onerror = () => { if (spinnerOverlay) spinnerOverlay.classList.add('hidden'); alert("Erreur chargement image."); imgElement.onerror = null; };
                    const newSrc = `${result.new_path}?v=${new Date().getTime()}`;
                    imgElement.src = newSrc;
                    if (glightboxLink) glightboxLink.href = newSrc;
                } else {
                    alert(`Erreur : ${result.message}`);
                    if (spinnerOverlay) spinnerOverlay.classList.add('hidden');
                }
            } catch (error) {
                alert("Erreur de communication avec le serveur.");
                if (spinnerOverlay) spinnerOverlay.classList.add('hidden');
            }
        }
    });
});
// Scripts d'import améliorés avec feedback détaillé
document.addEventListener("DOMContentLoaded", () => {
    
    function createStyledMessage(message, type = 'info') {
        const div = document.createElement('div');
        div.className = `status-message status-${type}`;
        div.textContent = message;
        return div;
    }

    function displayMessage(container, message, type = 'info') {
        // Utilise le type fourni par le serveur ('info', 'success', 'warning', 'error')
        // pour choisir la bonne couleur de message.
        const messageElement = createStyledMessage(message, type);
        container.appendChild(messageElement);
        container.scrollTop = container.scrollHeight;
    }

    // --- Gestion des favoris (placé ici pour être sûr que le DOM est chargé) ---
    document.querySelectorAll('.favorite-btn').forEach(button => {
        button.addEventListener('click', async (event) => {
            const btn = event.currentTarget;
            const photo = btn.dataset.photo;

            btn.disabled = true; // Empêcher les clics multiples

            try {
                const response = await fetch('/api/toggle_favorite', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ photo: photo })
                });
                const result = await response.json();
                if (result.success) {
                    // Mettre à jour tous les boutons correspondants (un dans l'aperçu, un dans les favoris)
                    document.querySelectorAll(`.favorite-btn[data-photo="${photo}"]`).forEach(b => {
                        b.classList.toggle('text-yellow-400', result.is_favorite);
                        b.classList.toggle('text-gray-400', !result.is_favorite);
                    });

                    // --- Logique de mise à jour dynamique ---
                    const favoritesBadge = document.getElementById('favorites-count-badge');
                    let count = parseInt(favoritesBadge.textContent, 10) || 0;

                    if (result.is_favorite) {
                        count++;
                    } else {
                        count = Math.max(0, count - 1);
                        const tileToRemove = document.querySelector(`#tab-favoris .photo-tile[data-path="${photo}"]`);
                        if (tileToRemove) tileToRemove.remove();
                    }
                    
                    favoritesBadge.textContent = count;
                    favoritesBadge.classList.toggle('hidden', count === 0);
                    const noFavMsg = document.getElementById('no-favorites-message');
                    if (noFavMsg && count === 0) noFavMsg.classList.remove('hidden');

                } else { alert(`Erreur: ${result.message}`); }
            } catch (error) { alert("Erreur de communication avec le serveur."); } 
            finally { btn.disabled = false; }
        });
    });

    // ----- IMPORT USB AMÉLIORÉ -----
    document.getElementById("usb-import-btn").addEventListener("click", () => {
        const btn = document.getElementById("usb-import-btn");
        const progressBar = document.getElementById("usb-progress-bar");
        const progressContainer = document.getElementById("usb-progress-container");
        const statusDiv = document.getElementById("usb-import-status");

        // Désactiver le bouton pendant l'import
        btn.disabled = true;
        btn.textContent = "Import en cours...";
        btn.classList.add("opacity-50", "cursor-not-allowed");

        // Reset de l'interface
        progressBar.style.width = "0%";
        progressBar.textContent = "0%";
        progressContainer.classList.remove("hidden");
        statusDiv.innerHTML = "";
        
        let importTermine = false;
        let timeoutId = null;

        const eventSource = new EventSource('/import-usb');

        eventSource.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                
                progressBar.style.width = `${data.percent || 0}%`;
                progressBar.textContent = `${data.percent || 0}%`;
                
                displayMessage(statusDiv, data.message, data.type);

                if (data.type === 'done') {
                    eventSource.close();
                    displayMessage(statusDiv, "Importation réussie ! Rechargement de la page...", 'success');
                    setTimeout(() => { location.reload(); }, 2000);
                } else if (data.type === 'error') {
                    eventSource.close();
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.textContent = "Importer depuis la clé USB";
                        btn.classList.remove("opacity-50", "cursor-not-allowed");
                    }, 5000);
                }
            } catch (e) {
                displayMessage(statusDiv, "Données invalides reçues du serveur.", 'error');
            }
        };

        eventSource.onerror = () => {
            eventSource.close();
            displayMessage(statusDiv, "Erreur de connexion au serveur pour l'import USB.", 'error');
            setTimeout(() => {
                btn.disabled = false;
                btn.textContent = "Importer depuis la clé USB";
                btn.classList.remove("opacity-50", "cursor-not-allowed");
                progressContainer.classList.add("hidden");
                statusDiv.innerHTML = "";
            }, 5000);
        };
    });

    // ----- IMPORT IMMICH AMÉLIORÉ -----
    document.getElementById("immich-import-btn").addEventListener("click", () => {
        const btn = document.getElementById("immich-import-btn");
        const progressBar = document.getElementById("immich-progress-bar");
        const progressContainer = document.getElementById("immich-progress-container");
        const statusDiv = document.getElementById("immich-import-status");
        // Désactiver le bouton pendant l'import
        btn.disabled = true;
        btn.textContent = "Import en cours...";
        btn.classList.add("opacity-50", "cursor-not-allowed");
        // Reset de l'interface
        progressBar.style.width = "0%";
        progressBar.textContent = "0%";
        progressContainer.classList.remove("hidden");
        statusDiv.innerHTML = "";
        
        const eventSource = new EventSource('/import-immich');

        eventSource.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                
                progressBar.style.width = `${data.percent || 0}%`;
                progressBar.textContent = `${data.percent || 0}%`;
                
                displayMessage(statusDiv, data.message, data.type);

                if (data.type === 'done') {
                    eventSource.close();
                    displayMessage(statusDiv, "Importation réussie ! Rechargement de la page...", 'success');
                    setTimeout(() => { location.reload(); }, 2000);
                } else if (data.type === 'error') {
                    eventSource.close();
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.textContent = "Importer les photos depuis Immich";
                        btn.classList.remove("opacity-50", "cursor-not-allowed");
                    }, 5000);
                }
            } catch (e) {
                displayMessage(statusDiv, "Données invalides reçues du serveur.", 'error');
            }
        };

        eventSource.onerror = () => {
            eventSource.close();
            displayMessage(statusDiv, "Erreur de connexion au serveur pour l'import Immich.", 'error');
            setTimeout(() => {
                btn.disabled = false;
                btn.textContent = "Importer les photos depuis Immich";
                btn.classList.remove("opacity-50", "cursor-not-allowed");
                progressContainer.classList.add("hidden");
                statusDiv.innerHTML = "";
            }, 5000);
        };
    });

    // ----- IMPORT SAMBA -----
    document.getElementById("samba-import-btn").addEventListener("click", () => {
        const btn = document.getElementById("samba-import-btn");
        const progressBar = document.getElementById("samba-progress-bar");
        const progressContainer = document.getElementById("samba-progress-container");
        const statusDiv = document.getElementById("samba-import-status");

        btn.disabled = true;
        btn.textContent = "Import en cours...";
        btn.classList.add("opacity-50", "cursor-not-allowed");

        progressBar.style.width = "0%";
        progressBar.textContent = "0%";
        progressContainer.classList.remove("hidden");
        statusDiv.innerHTML = "";

        const eventSource = new EventSource('/import-samba');

        eventSource.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                
                progressBar.style.width = `${data.percent || 0}%`;
                progressBar.textContent = `${data.percent || 0}%`;
                
                displayMessage(statusDiv, data.message, data.type);

                if (data.type === 'done') {
                    eventSource.close();
                    displayMessage(statusDiv, "Importation réussie ! Rechargement de la page...", 'success');
                    setTimeout(() => { location.reload(); }, 2000);
                } else if (data.type === 'error') {
                    eventSource.close();
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.textContent = "Importer depuis Samba";
                        btn.classList.remove("opacity-50", "cursor-not-allowed");
                    }, 5000);
                }
            } catch (e) {
                displayMessage(statusDiv, "Données invalides reçues du serveur.", 'error');
            }
        };

        eventSource.onerror = () => {
            eventSource.close();
            displayMessage(statusDiv, "Erreur de connexion au serveur pour l'import Samba.", 'error');
            setTimeout(() => {
                btn.disabled = false;
                btn.textContent = "Importer depuis Samba";
                btn.classList.remove("opacity-50", "cursor-not-allowed");
                progressContainer.classList.add("hidden");
                statusDiv.innerHTML = "";
            }, 5000);
        };
    });

    // ----- TEST SAMBA CONNECTION -----
    document.getElementById("samba-test-btn").addEventListener("click", async () => {
        const btn = document.getElementById("samba-test-btn");
        const statusSpan = document.getElementById("samba-test-status");

        // Get values from the form
        const host = document.getElementById("smb_host").value;
        const share = document.getElementById("smb_share").value;
        const path = document.getElementById("smb_path").value;
        const user = document.getElementById("smb_user").value;
        const password = document.getElementById("smb_password").value;

        // Provide immediate feedback
        statusSpan.textContent = "Test en cours...";
        statusSpan.className = "ml-4 font-medium text-blue-600";
        btn.disabled = true;

        try {
            const response = await fetch('/test-samba', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    smb_host: host,
                    smb_share: share,
                    smb_path: path,
                    smb_user: user,
                    smb_password: password
                }),
            });

            const result = await response.json();

            statusSpan.textContent = result.message;
            statusSpan.className = result.success ? "ml-4 font-medium text-green-600" : "ml-4 font-medium text-red-600";

        } catch (error) {
            statusSpan.textContent = "Erreur de communication avec le serveur.";
            statusSpan.className = "ml-4 font-medium text-red-600";
        } finally {
            btn.disabled = false;
        }
    });

    // ----- TEST WEATHER API -----
    const testWeatherBtn = document.getElementById("testWeatherApiKeyBtn");
    if (testWeatherBtn) {
        testWeatherBtn.addEventListener("click", async () => {
            const btn = testWeatherBtn;
            const statusSpan = document.getElementById("weatherApiTestResult");

            const apiKey = document.getElementById("weather_api_key").value;
            const city = document.getElementById("weather_city").value;

            statusSpan.textContent = "Test en cours...";
            statusSpan.className = "ml-4 font-medium text-blue-600";
            btn.disabled = true;

            try {
                const response = await fetch('/test-weather-api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ api_key: apiKey, city: city }),
                });

                const result = await response.json();

                statusSpan.textContent = result.message;
                statusSpan.className = result.success ? "ml-4 font-medium text-green-600" : "ml-4 font-medium text-red-600";

            } catch (error) {
            statusSpan.textContent = "Erreur de communication avec le serveur.";
                statusSpan.className = "ml-4 font-medium text-red-600";
            } finally {
                btn.disabled = false;
            }
        });
    }

    // --- État des marées ---
    async function fetchTideInfo() {
        const tideLastUpdate = document.getElementById('tide-last-update');
        const tideNextHigh = document.getElementById('tide-next-high');
        const tideNextLow = document.getElementById('tide-next-low');
        const tideApiStatus = document.getElementById('tide-api-status');

        try {
            const response = await fetch('/api/tide_info');
            const data = await response.json();

            if (data.success) {
                tideLastUpdate.textContent = data.last_update || 'N/A';
                tideNextHigh.textContent = data.next_high || 'N/A';
                tideNextLow.textContent = data.next_low || 'N/A';
                tideApiStatus.textContent = data.api_status || 'OK';
                tideApiStatus.className = data.api_status.includes('cooldown') || data.api_status.includes('Erreur') ? 'font-mono text-yellow-600' : 'font-mono text-green-600';
            } else {
                tideLastUpdate.textContent = 'N/A';
                tideNextHigh.textContent = 'N/A';
                tideNextLow.textContent = 'N/A';
                tideApiStatus.textContent = data.message || 'Impossible de charger les données.';
                tideApiStatus.className = 'font-mono text-red-600';
            }
        } catch (error) {
            console.error("Erreur de communication avec l'API des marées:", error);
            tideApiStatus.textContent = "Erreur de connexion au serveur.";
            tideApiStatus.className = 'font-mono text-red-600';
        }
    }


    // ----- TEST STORMGLASS API -----
    const testStormglassBtn = document.getElementById("testStormglassApiKeyBtn");
    if (testStormglassBtn) {
        testStormglassBtn.addEventListener("click", async () => {
            const btn = testStormglassBtn;
            const statusSpan = document.getElementById("stormglassApiTestResult");

            const apiKey = document.getElementById("stormglass_api_key").value;
            const lat = document.getElementById("tide_latitude").value;
            const lon = document.getElementById("tide_longitude").value;

            statusSpan.textContent = "Test en cours...";
            statusSpan.className = "ml-4 font-medium text-blue-600";
            btn.disabled = true;

            try {
                const response = await fetch('/test-stormglass-api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ api_key: apiKey, lat: lat, lon: lon }),
                });

                const result = await response.json();

                statusSpan.textContent = result.message;
                statusSpan.className = result.success ? "ml-4 font-medium text-green-600" : "ml-4 font-medium text-red-600";

            } catch (error) {
                statusSpan.textContent = "Erreur de communication avec le serveur.";
                statusSpan.className = "ml-4 font-medium text-red-600";
            } finally {
                btn.disabled = false;
            }
        });
    }

    // ----- FORCE TIDE UPDATE -----
    const forceTideBtn = document.getElementById("forceTideUpdateBtn");
    if (forceTideBtn) {
        forceTideBtn.addEventListener("click", async () => {
            const btn = forceTideBtn;
            const statusSpan = document.getElementById("forceTideUpdateResult");

            statusSpan.textContent = "Mise à jour en cours...";
            statusSpan.className = "ml-4 font-medium text-blue-600";
            btn.disabled = true;

            try {
                const response = await fetch('/api/force_tide_update', {
                    method: 'POST'
                });

                const result = await response.json();

                statusSpan.textContent = result.message;
                statusSpan.className = result.success ? "ml-4 font-medium text-green-600" : "ml-4 font-medium text-red-600";
                
                if (result.success) {
                    fetchTideInfo(); // Rafraîchir l'affichage de l'état des marées
                }
            } catch (error) {
                statusSpan.textContent = "Erreur de communication avec le serveur.";
                statusSpan.className = "ml-4 font-medium text-red-600";
            } finally {
                btn.disabled = false;
            }
        });
    }

    // Mise à jour périodique
    fetchTideInfo(); // Appel initial
    setInterval(fetchTideInfo, 30000); // Mise à jour toutes les 30 secondes

    // ----- IMPORT SMARTPHONE -----
    document.getElementById('smartphone-upload-form').addEventListener('submit', function(event) {
        event.preventDefault(); // Prevent default form submission

        const form = event.target;
        const formData = new FormData(form);
        const btn = document.getElementById('import-smartphone-btn');
        const progressBar = document.getElementById('smartphone-progress-bar');
        const progressContainer = document.getElementById('smartphone-progress-container');
        const statusDiv = document.getElementById('smartphone-import-status');
        const allImportButtons = document.querySelectorAll('.import-button, #import-smartphone-btn');
        let hasErrorOccurred = false; // Flag to track errors

        // Check if files were selected
        if (!formData.has('photos') || !formData.get('photos').name) {
            displayMessage(statusDiv, "Veuillez sélectionner au moins un fichier.", 'error');
            return;
        }

        // Disable all import buttons
        allImportButtons.forEach(b => {
            b.disabled = true;
            b.classList.add("opacity-50", "cursor-not-allowed");
        });
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Envoi en cours...';

        // Reset UI
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';
        progressContainer.classList.remove('hidden');
        statusDiv.innerHTML = '';

        fetch('/import-smartphone', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Erreur HTTP: ${response.status}`);
            }
            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            function processStream() {
                reader.read().then(({ done, value }) => {
                    if (done) { // Stream finished
                        if (!hasErrorOccurred) {
                            displayMessage(statusDiv, "Importation réussie ! Rechargement de la page...", 'success');
                            setTimeout(() => { location.reload(); }, 2000);
                        } else {
                            // Re-enable buttons after a delay if there was an error
                            setTimeout(() => {
                                allImportButtons.forEach(b => {
                                    b.disabled = false;
                                    b.classList.remove("opacity-50", "cursor-not-allowed");
                                });
                                btn.innerHTML = '<i class="fas fa-upload"></i> Envoyer les photos';
                            }, 5000);
                        }
                        return; // End the stream processing
                    }

                    // Process the stream chunk
                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n\n');
                    lines.forEach(line => {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.substring(6));
                                progressBar.style.width = `${data.percent || 0}%`;
                                progressBar.textContent = `${data.percent || 0}%`;
                                displayMessage(statusDiv, data.message, data.type);
                                if (data.type === 'error') {
                                    hasErrorOccurred = true;
                                }
                            } catch (e) {
                                displayMessage(statusDiv, "Données invalides reçues du serveur.", 'error');
                                hasErrorOccurred = true;
                            }
                        }
                    });
                    processStream();
                });
            }
            processStream();
        })
        .catch(error => {
            displayMessage(statusDiv, `Erreur de communication: ${error.message}`, 'error');
            allImportButtons.forEach(b => { b.disabled = false; b.classList.remove("opacity-50", "cursor-not-allowed"); });
            btn.innerHTML = '<i class="fas fa-upload"></i> Envoyer les photos';
        });
    });

    // ----- GESTION DE LA VALIDATION (Écouteurs d'événements) -----
    // Ces écouteurs utilisent les fonctions globales définies plus haut.
    const grid = document.getElementById('pending-photos-grid');
    if (grid) {
        grid.addEventListener('click', function(event) {
        const approveBtn = event.target.closest('.approve-btn');
        const rejectBtn = event.target.closest('.reject-btn');
        const filename = event.target.closest('.photo-tile')?.dataset.filename;

        if (approveBtn && filename) {
            handlePendingAction(filename, 'approve');
        } else if (rejectBtn && filename) {
            handlePendingAction(filename, 'reject');
        }
        });
    }

    const refreshBtn = document.getElementById('refresh-pending-btn');
    if (refreshBtn) refreshBtn.addEventListener('click', refreshValidationTab);
});


</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    // Fonction pour formater les dates ISO en format lisible
    function formatDateTime(isoString) {
        if (!isoString) return "N/A";
        const date = new Date(isoString);
        // Options pour un format français lisible
        const options = {
            year: 'numeric', month: 'short', day: 'numeric',
            hour: '2-digit', minute: '2-digit', second: '2-digit',
            hour12: false // Format 24h
        };
        return date.toLocaleString('fr-FR', options);
    }

    // Fonction générique pour récupérer et afficher le statut d'un worker
    async function fetchWorkerStatus(workerName, statusManagerId, lastRunId, nextRunId) {
        try {
            const response = await fetch(`/${workerName}_update_status`);
            const data = await response.json();

            document.getElementById(statusManagerId).textContent = data.status_message;
            document.getElementById(lastRunId).textContent = formatDateTime(data.last_run);
            document.getElementById(nextRunId).textContent = formatDateTime(data.next_run);

        } catch (error) {
            console.error(`Erreur lors de la récupération du statut ${workerName}:`, error);
            document.getElementById(statusManagerId).textContent = "Erreur de connexion";
            document.getElementById(lastRunId).textContent = "N/A";
            document.getElementById(nextRunId).textContent = "N/A";
        }
    }

    // Mise à jour initiale au chargement de la page
    fetchWorkerStatus("immich", "immich-worker-status-message", "immich-last-update-time", "immich-next-update-time");
    fetchWorkerStatus("samba", "samba-worker-status-message", "samba-last-update-time", "samba-next-update-time");

    // Mise à jour périodique toutes les 5 secondes
    setInterval(() => {
        fetchWorkerStatus("immich", "immich-worker-status-message", "immich-last-update-time", "immich-next-update-time");
        fetchWorkerStatus("samba", "samba-worker-status-message", "samba-last-update-time", "samba-next-update-time");
    }, 5000); // 5000 ms = 5 secondes

    // --- Détection de la résolution ---
    const detectResBtn = document.getElementById("detect-resolution-btn");
    const slideshowIsRunning = {{ slideshow_running|tojson }};

    async function fetchAndSetResolution() {
        const originalText = detectResBtn.innerHTML;
        detectResBtn.innerHTML = 'Détection...';
        detectResBtn.disabled = true;

        try {
            const response = await fetch('/get_current_resolution');
            const data = await response.json();

            if (data.success) {
                document.getElementById('display_width').value = data.width;
                document.getElementById('display_height').value = data.height;
                detectResBtn.innerHTML = 'Détecté !';
            } else {
                alert(data.message || "Erreur lors de la détection.");
                detectResBtn.innerHTML = originalText;
            }
        } catch (error) {
            alert("Erreur de communication avec le serveur.");
            detectResBtn.innerHTML = originalText;
        } finally {
            setTimeout(() => {
                detectResBtn.innerHTML = originalText;
                detectResBtn.disabled = !slideshowIsRunning;
            }, 2000);
        }
    }

    if (slideshowIsRunning) {
        detectResBtn.disabled = false;
        fetchAndSetResolution(); // Appel automatique au chargement de la page
    } else {
        detectResBtn.disabled = true;
    }

    detectResBtn.addEventListener("click", fetchAndSetResolution);

    // --- Aperçu en direct ---
    const livePreviewImage = document.getElementById('live-preview-image');
    const livePreviewStatus = document.getElementById('live-preview-status');

    async function updateLivePreview() {
        try {
            const response = await fetch('/current_photo_status');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();

            if (data.status === 'stopped') {
                livePreviewStatus.textContent = 'Le diaporama est arrêté.';
                livePreviewStatus.classList.remove('hidden');
                livePreviewImage.classList.add('hidden');
            } else {
                if (data.current_photo) {
                    // Mettre à jour la source de l'image uniquement si elle a changé
                    if (livePreviewImage.src !== data.current_photo) {
                         livePreviewImage.src = data.current_photo;
                    }
                    livePreviewStatus.classList.add('hidden');
                    livePreviewImage.classList.remove('hidden');
                } else {
                    livePreviewStatus.textContent = 'En attente de la prochaine photo...';
                    livePreviewStatus.classList.remove('hidden');
                    livePreviewImage.classList.add('hidden');
                }
            }
        } catch (error) {
            console.error('Erreur de mise à jour de l\'aperçu en direct:', error);
            livePreviewStatus.textContent = 'Erreur de connexion.';
            livePreviewStatus.classList.remove('hidden');
            livePreviewImage.classList.add('hidden');
        }
    }

    // Mettre à jour toutes les 5 secondes et une fois au chargement
    setInterval(updateLivePreview, 5000);
    updateLivePreview();

    // --- Informations Système et Logs ---

    // Fonction pour récupérer et afficher l'état du Wi-Fi
    async function fetchWifiStatus() {
        const stateSpan = document.getElementById('wifi-connection-state');
        const ssidSpan = document.getElementById('wifi-current-ssid');
        const ipSpan = document.getElementById('wifi-ip-address');

        try {
            const response = await fetch('/api/wifi_status');
            const data = await response.json();
            if (data.success) {
                if (data.is_connected) {
                    stateSpan.textContent = "Connecté";
                    stateSpan.className = "text-green-600 font-semibold";
                    ssidSpan.textContent = data.ssid;
                    ipSpan.textContent = data.ip_address;
                } else {
                    stateSpan.textContent = "Non connecté";
                    stateSpan.className = "text-red-600 font-semibold";
                    ssidSpan.textContent = "N/A";
                    ipSpan.textContent = "N/A";
                }
            } else {
                throw new Error("Réponse de l'API invalide");
            }
        } catch (error) {
            console.error("Erreur de communication avec l'API Wi-Fi:", error);
            stateSpan.textContent = "Erreur de connexion";
            stateSpan.className = "text-red-600 font-semibold";
            ssidSpan.textContent = "N/A";
            ipSpan.textContent = "N/A";
        }
    }

    // --- Gestion des Interfaces Réseau ---
    async function fetchInterfaceStatus(interfaceName) {
        const stateSpan = document.getElementById(`${interfaceName}-state`);
        const ipSpan = document.getElementById(`${interfaceName}-ip`);
        const toggleBtn = document.getElementById(`toggle-${interfaceName}-btn`);

        if (!stateSpan || !ipSpan || !toggleBtn) return;

        try {
            const response = await fetch(`/api/interface_status/${interfaceName}`);
            const data = await response.json();

            if (data.success) {
                if (data.state === "UP") {
                    stateSpan.textContent = "Activée";
                    stateSpan.className = "font-mono text-green-600";
                    ipSpan.textContent = data.ip_address;
                    toggleBtn.textContent = "Désactiver";
                    toggleBtn.className = "system-button bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded";
                    toggleBtn.dataset.nextState = "down";
                } else if (data.state === "DOWN") {
                    stateSpan.textContent = "Désactivée";
                    stateSpan.className = "font-mono text-gray-500";
                    ipSpan.textContent = "N/A";
                    toggleBtn.textContent = "Activer";
                    toggleBtn.className = "system-button bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded";
                    toggleBtn.dataset.nextState = "up";
                } else { // NOT_FOUND
                    stateSpan.textContent = "Non trouvée";
                    stateSpan.className = "font-mono text-red-600";
                    ipSpan.textContent = "N/A";
                    toggleBtn.textContent = "Indisponible";
                    toggleBtn.className = "system-button bg-gray-400 text-white font-bold py-2 px-4 rounded cursor-not-allowed";
                    toggleBtn.disabled = true;
                    return;
                }
                toggleBtn.disabled = false;
            } else { throw new Error(data.message || "Réponse API invalide"); }
        } catch (error) {
            console.error(`Erreur de communication pour l'interface ${interfaceName}:`, error);
            stateSpan.textContent = "Erreur"; ipSpan.textContent = "N/A";
            toggleBtn.textContent = "Erreur"; toggleBtn.disabled = true;
        }
    }

    const toggleEth0Btn = document.getElementById('toggle-eth0-btn');
    if (toggleEth0Btn) {
        toggleEth0Btn.addEventListener('click', async () => {
            const interfaceName = 'eth0';
            const nextState = toggleEth0Btn.dataset.nextState;

            toggleEth0Btn.disabled = true;
            toggleEth0Btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const response = await fetch('/api/set_interface_state', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ interface: interfaceName, state: nextState })
                });
                const result = await response.json();
                if (!result.success) { alert(`Erreur: ${result.message}`); }
                setTimeout(() => fetchInterfaceStatus(interfaceName), 1000);
            } catch (error) {
                alert("Erreur de communication avec le serveur.");
                fetchInterfaceStatus(interfaceName);
            }
        });
    }

    // Fonction pour récupérer et afficher les informations système
    async function fetchSystemInfo() {
        try {
            const response = await fetch('/api/system_info');
            const data = await response.json();
            if (data.success) {
                document.getElementById('cpu-temp').textContent = data.cpu_temp;
                document.getElementById('cpu-usage').textContent = data.cpu_usage;
                document.getElementById('ram-usage').textContent = data.ram_usage;
                document.getElementById('disk-usage').textContent = data.disk_usage;
            } else {
                console.error("{{ _('Erreur lors de la récupération des infos système:') }}", data.message);
                document.getElementById('cpu-temp').textContent = i18n.notAvailable;
                document.getElementById('cpu-usage').textContent = i18n.notAvailable;
                document.getElementById('ram-usage').textContent = i18n.notAvailable;
                document.getElementById('disk-usage').textContent = i18n.notAvailable;
            }
        } catch (error) {
            console.error("{{ _('Erreur de communication avec l\'API système:') }}", error);
            document.getElementById('cpu-temp').textContent = i18n.error;
            document.getElementById('cpu-usage').textContent = i18n.error;
            document.getElementById('ram-usage').textContent = i18n.error;
            document.getElementById('disk-usage').textContent = i18n.error;
        }
    }

    // Fonction pour récupérer et afficher les logs
    async function fetchLogs() {
        const logType = document.getElementById('log-selector').value;
        const logContentElement = document.getElementById('log-content');
        try {
            const response = await fetch(`/api/logs?type=${logType}`);
            const data = await response.json();
            if (data.success) {
                if (data.content && data.content.trim() !== '') {
                    logContentElement.textContent = data.content;
                } else {
                    // Utiliser un espace insécable pour s'assurer que la balise <pre> conserve ses dimensions
                    // lorsqu'elle est vide, ce qui évite les problèmes de mise en page.
                    logContentElement.innerHTML = '&nbsp;';
                }
                // Le défilement est maintenant sur le conteneur parent de la balise <pre>
                logContentElement.parentElement.scrollTop = logContentElement.parentElement.scrollHeight;
            } else {
                logContentElement.textContent = `{{ _('Erreur:') }} ${data.message}`;
            }
        } catch (error) {
            console.error("Erreur de communication avec l'API logs:", error);
            logContentElement.textContent = "{{ _('Erreur de connexion à l\'API des logs.') }}";
        }
    }

    // Mettre à jour les infos système toutes les 5 secondes
    setInterval(fetchSystemInfo, 5000);
    setInterval(fetchWifiStatus, 5000);
    setInterval(() => fetchInterfaceStatus('eth0'), 5000);
    // Mettre à jour les logs toutes les 10 secondes (ou sur demande)
    setInterval(fetchLogs, 10000);

    // Écouteurs d'événements pour les logs
    document.getElementById('log-selector').addEventListener('change', fetchLogs);
    document.getElementById('refresh-logs-btn').addEventListener('click', fetchLogs);
    document.getElementById('clear-logs-btn').addEventListener('click', async () => {
        const logSelector = document.getElementById('log-selector');
        const logType = logSelector.value;
        const logName = logSelector.options[logSelector.selectedIndex].text;

        const templateMsg = `{{ _('Êtes-vous sûr de vouloir effacer le contenu du log "__LOG_NAME__" ? Cette action est irréversible.') }}`;
        if (!confirm(templateMsg.replace('__LOG_NAME__', logName))) {
            return;
        }

        try {
            const response = await fetch('/api/clear_logs', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: logType })
            });
            const data = await response.json();
            if (data.success) {
                fetchLogs(); // Rafraîchir la vue pour montrer que le log est vide
            } else {
                alert(`{{ _('Erreur lors de l\'effacement du log :') }} ${data.message}`);
            }
        } catch (error) {
            alert("{{ _('Erreur de connexion à l\'API pour effacer les logs.') }}");
        }
    });

    // Appel initial au chargement de la page pour les infos système et les logs
    fetchSystemInfo();
    fetchLogs();
    fetchInterfaceStatus('eth0');
    fetchWifiStatus();

    // --- Scan Wi-Fi ---
    const scanBtn = document.getElementById('scan-wifi-btn');
    const scanBtnText = document.getElementById('scan-wifi-btn-text');
    const resultsDiv = document.getElementById('wifi-scan-results');
    const ssidInput = document.getElementById('wifi_ssid');

    if (scanBtn) {
        // Fonction pour obtenir une icône Wi-Fi colorée en fonction de la force du signal
        function getSignalIconHtml(signal) {
            let colorClass = 'text-gray-400'; // Faible ou par défaut
            if (signal > 75) {
                colorClass = 'text-green-500'; // Fort
            } else if (signal > 50) {
                colorClass = 'text-green-400'; // Bon
            } else if (signal > 25) {
                colorClass = 'text-yellow-500'; // Moyen
            } else {
                colorClass = 'text-red-500'; // Faible
            }
            return `<i class="fas fa-wifi ${colorClass} fa-fw mr-2"></i>`;
        }

        scanBtn.addEventListener('click', function() {
            resultsDiv.innerHTML = `
                <div class="p-4 text-sm text-blue-700 bg-blue-100 rounded-lg flex items-center" role="alert">
                    <i class="fas fa-spinner fa-spin mr-3"></i>
                    <span>${i18n.scanInProgress}</span>
                </div>`;
            scanBtn.disabled = true;
            scanBtnText.textContent = i18n.scanInProgress;

            fetch('/api/scan_wifi')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (data.networks && data.networks.length > 0) {
                            let table = `
                                <div class="overflow-x-auto relative shadow-md sm:rounded-lg">
                                    <table class="w-full text-sm text-left text-gray-500">
                                        <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                            <tr>
                                                <th scope="col" class="py-3 px-6">${i18n.headerSSID}</th>
                                                <th scope="col" class="py-3 px-6">${i18n.headerSecurity}</th>
                                                <th scope="col" class="py-3 px-6">${i18n.headerSignal}</th>
                                            </tr>
                                        </thead>
                                        <tbody>`;
                            data.networks.forEach(net => {
                                table += `
                                    <tr class="bg-white border-b hover:bg-gray-50 cursor-pointer wifi-row" data-ssid="${net.ssid}" title="${i18n.selectNetworkTitle}">
                                        <td class="py-4 px-6 font-medium text-gray-900 whitespace-nowrap">${net.ssid}</td>
                                        <td class="py-4 px-6">${net.security || i18n.noSecurity}</td>
                                        <td class="py-4 px-6 flex items-center">${getSignalIconHtml(net.signal)}<span>${net.signal}%</span></td>
                                    </tr>`;
                            });
                            table += '</tbody></table></div>';
                            resultsDiv.innerHTML = table;

                            // Ajouter les écouteurs d'événements pour chaque ligne du tableau
                            document.querySelectorAll('.wifi-row').forEach(row => {
                                row.addEventListener('click', function() {
                                    const selectedSsid = this.dataset.ssid;
                                    if (ssidInput) {
                                        ssidInput.value = selectedSsid;
                                        ssidInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                        ssidInput.focus();
                                    }
                                });
                            });

                        } else {
                            resultsDiv.innerHTML = `<div class="p-4 text-sm text-yellow-700 bg-yellow-100 rounded-lg" role="alert">${i18n.noNetworksFound}</div>`;
                        }
                    } else {
                        resultsDiv.innerHTML = `<div class="p-4 text-sm text-red-700 bg-red-100 rounded-lg" role="alert"><strong>${i18n.error}:</strong> ${data.message}</div>`;
                    }
                })
                .catch(error => {
                    resultsDiv.innerHTML = `<div class="p-4 text-sm text-red-700 bg-red-100 rounded-lg" role="alert"><strong>${i18n.error}:</strong> ${i18n.commError} ${error}</div>`;
                })
                .finally(() => {
                    scanBtn.disabled = false;
                    scanBtnText.textContent = i18n.startScan;
                });
        });
    }
});
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Configuration - Pimmich</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <!-- GLightbox CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css" />

</head>
<body>
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-messages">
          {% for category, message in messages %}
            <div class="alert alert-{{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="container">
        <img src="{{ url_for('static', filename='pimmich_logo.png') }}" alt="Logo Pimmich" class="logo">
        <h2>Configuration du cadre photo connecté</h2>

        <div class="logout-link">
            <a href="/logout">&#128682; Se déconnecter</a>
        </div>
        

<div class="tabs">
  <button class="tablink active" onclick="openTab(event, 'tab-affichage')">Affichage</button>
  <button class="tablink" onclick="openTab(event, 'tab-heure')">Heure</button>
  <button class="tablink" onclick="openTab(event, 'tab-sources')">Sources des photos</button>
  <button class="tablink" onclick="openTab(event, 'tab-apercu')">Aperçu</button>
  <button class="tablink" onclick="openTab(event, 'tab-actions')">Actions</button>
</div>

<form method="POST" action="/configure">

<div id="tab-affichage" class="tabcontent" style="display:block">
    <fieldset>
        <legend><h3>Paramètres d'affichage</h3></legend>

        <label for="display_duration">Durée d'affichage (en secondes) :</label>
        <input type="number" id="display_duration" name="display_duration" value="{{ config.display_duration }}" required>

        <label for="active_start">Heure de début d'activité (HH:MM) :</label>
        <input type="time" id="active_start" name="active_start" value="{{ config.active_start }}">

        <label for="active_end">Heure de fin d'activité (HH:MM) :</label>
        <input type="time" id="active_end" name="active_end" value="{{ config.active_end }}">

        <label for="screen_height_percent">Hauteur utile de l'écran (% affiché) :</label>
        <input type="number" id="screen_height_percent" name="screen_height_percent" min="10" max="100" value="{{ config.screen_height_percent }}">
    </fieldset>
</div>

 
                    
<div id="tab-heure" class="tabcontent">
    <fieldset>
        <legend><strong>Affichage de l'heure</strong></legend>

                    
                      <div style="margin-bottom: 8px;">
                        <label>
                          <input type="checkbox" name="show_clock" {% if config.get('show_clock', False) %}checked{% endif %}>
                          Afficher l'heure
                        </label>
                      </div>
                    
                      <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <label for="clock_font_size" style="min-width: 200px;">Taille de la police :</label>
                        <input type="number" name="clock_font_size" value="{{ config.get('clock_font_size', 48) }}">
                      </div>
                    
                      <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <label for="clock_offset_x" style="min-width: 200px;">Décalage horizontal (px) :</label>
                        <input type="number" name="clock_offset_x" value="{{ config.get('clock_offset_x', 30) }}">
                      </div>
                    
                      <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <label for="clock_offset_y" style="min-width: 200px;">Décalage vertical (px) :</label>
                        <input type="number" name="clock_offset_y" value="{{ config.get('clock_offset_y', 30) }}">
                      </div>
                    
                      <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <label for="clock_color" style="min-width: 200px;">Couleur du texte (hex) :</label>
                        <input type="text" name="clock_color" value="{{ config.get('clock_color', '#FFFFFF') }}">
                      </div>
                    
                      <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <label for="clock_outline_color" style="min-width: 200px;">Couleur du contour (hex) :</label>
                        <input type="text" name="clock_outline_color" value="{{ config.get('clock_outline_color', '#000000') }}">
                      </div>
                    
                      <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <label for="clock_position" style="min-width: 200px;">Position de l'heure :</label>
                        <select name="clock_position">
                          <option value="left" {% if config.get('clock_position') == 'left' %}selected{% endif %}>Gauche</option>
                          <option value="center" {% if config.get('clock_position') == 'center' %}selected{% endif %}>Centre</option>
                          <option value="right" {% if config.get('clock_position') == 'right' %}selected{% endif %}>Droite</option>
                        </select>
                      </div>
                    
                      <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <label for="clock_font_path" style="min-width: 200px;">Police :</label>
                        <select name="clock_font_path">
                          {% set fonts = [
                              ('/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf', 'DejaVu Sans Bold'),
                              ('/usr/share/fonts/truetype/liberation/LiberationSans-Regular.ttf', 'Liberation Sans'),
                              ('/usr/share/fonts/truetype/freefont/FreeSans.ttf', 'FreeSans')
                          ] %}
                          {% for path, label in fonts %}
                            <option value="{{ path }}" {% if config.get('clock_font_path') == path %}selected{% endif %}>{{ label }}</option>
                          {% endfor %}
                        </select>
                      </div>
           </fieldset>
</div>


<div id="tab-sources" class="tabcontent">
    <fieldset>
        <legend><h3>Configuration de l'album photo Immich</h3></legend>
                   

                        <label for="source">Source des photos :</label>
                        <select id="source" name="source">
                            <option value="immich" {% if config.source == 'immich' %}selected{% endif %}>Album Immich</option>
                            <option value="usb" {% if config.source == 'usb' %}selected{% endif %}>Clé USB</option>
                        </select>

                        <label for="album_name">Nom technique de l'album Immich :</label>
                        <input type="text" id="album_name" name="album_name" value="{{ config.album_name }}">


                        <label for="immich_url">URL du serveur Immich :</label>
                        <input type="url" id="immich_url" name="immich_url" value="{{ config.immich_url }}">

                        <label for="immich_token">Token d'accès Immich :</label>
                        <input type="text" id="immich_token" name="immich_token" value="{{ config.immich_token }}">




     </fieldset>
</div>

   
    <button type="submit" class="save-button">Enregistrer</button>

</form> 

<div id="tab-actions" class="tabcontent">
    <fieldset>
        <legend><h3>Actions</h3></legend>
                    <form method="POST" action="/toggle_slideshow">
                        <button type="submit">
                            {% if slideshow_running %} Arrêter{% else %} Démarrer{% endif %} le diaporama
                        </button>
                    </form>

                    <button id="usb-import-btn" class="bg-rose-600 hover:bg-rose-700 text-white font-bold py-2 px-4 rounded mt-4">
                        Importer les photos depuis la clé USB
                    </button>
                    <div id="usb-import-status" class="mt-4 space-y-1 text-sm font-medium"></div>



                    <button id="immich-download-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mt-4">
                        Télécharger et préparer les photos
                    </button>
                    <div id="import-status" class="mt-4 space-y-1 text-sm font-medium"></div>

                    <form method="POST" action="/reboot">
                        <button type="submit">Redémarrer le système</button>
                    </form>

                    <form method="POST" action="/shutdown">
                        <button type="submit">Éteindre le système</button>
                    </form>
  </fieldset>


  <fieldset>
                    <legend><h3>Crédits</h3></legend>
                    <div class="credits">
                        <img src="{{ url_for('static', filename='gotenash.jpg') }}" width="120">
                        <p>Auteurs : Gotenash et Shenron</p>
                        <a href="https://www.gadgetaulab.fr">
                            <img src="{{ url_for('static', filename='logo_gadgeto.png') }}" width="120">
                        </a>
                        <p>Projet réalisé dans le cadre du Gadgetaulab</p>
                    </div>
    </fieldset>
</div>
            
            
            
<div id="tab-apercu" class="tabcontent">
    {% if photos %}
    <fieldset class="photo-preview-section">
        <legend>Aperçu des photos préparées</legend>
        

            <div class="photo-grid">
                {% for photo in photos %}
                <div class="photo-tile">
                    <a href="{{ url_for('static', filename='prepared/' + photo) }}" class="glightbox" data-gallery="gallery1">
                      <img src="{{ url_for('static', filename='prepared/' + photo) }}" class="w-32 h-32 object-cover rounded shadow cursor-pointer hover:scale-105 transition">
                    </a>
                    <button class="delete-button" data-photo="{{ photo }}" title="Supprimer">✖</button>

                </div>
              
                {% endfor %}
            </div>
            
  </fieldset>
        {% endif %}
</div>  

<script src="https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js"></script>
<script>
  const lightbox = GLightbox({
    selector: '.glightbox'
  });
</script>
<script>
function openTab(evt, tabId) {
  const tabcontent = document.getElementsByClassName("tabcontent");
  const tablinks = document.getElementsByClassName("tablink");


  for (let i = 0; i < tabcontent.length; i++) {
    tabcontent[i].style.display = "none";
  }


  for (let i = 0; i < tablinks.length; i++) {
    tablinks[i].classList.remove("active");
  }


  document.getElementById(tabId).style.display = "block";

  evt.currentTarget.classList.add("active");
}
</script>

<script>

function openLightbox(src) {
  const lightbox = document.getElementById('lightbox');
  const img = document.getElementById('lightbox-img');
  img.src = src;
  lightbox.classList.remove('hidden');
}

function closeLightbox() {
  document.getElementById('lightbox').classList.add('hidden');
}


</script>


<script>
  document.querySelectorAll('.delete-button').forEach(button => {
    button.addEventListener('click', async () => {
      const photo = button.dataset.photo;
      const confirmDelete = confirm(`Supprimer la photo ${photo} ?`);
      if (!confirmDelete) return;

      const response = await fetch(`/delete_photo/${photo}`, { method: 'DELETE' });
      if (response.ok) {
        location.reload();
      } else {
        alert("Erreur lors de la suppression.");
      }
    });
  });
</script>




<script>
function displayStyledLine(container, line) {
    const p = document.createElement('p');
    p.textContent = line;

    if (line.includes("Erreur")) {
        p.className = "text-red-600";
    } else if (line.includes("Terminé")) {
        p.className = "text-green-600";
        setTimeout(() => {
            container.innerHTML = "";
        }, 5000);
    } else {
        p.className = "text-gray-700";
    }

    container.appendChild(p);
    container.scrollTop = container.scrollHeight;
}

document.getElementById("immich-download-btn").addEventListener("click", function () {
    const statusDiv = document.getElementById("import-status");
    statusDiv.innerHTML = "";
    fetch("/progress")
        .then(response => {
            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");

            function readChunk() {
                reader.read().then(({ done, value }) => {
                    if (done) return;
                    const lines = decoder.decode(value, { stream: true }).split("\n");
                    lines.forEach(line => {
                        if (line.trim() !== "") {
                            displayStyledLine(statusDiv, line.trim());
                        }
                    });
                    readChunk();
                });
            }
            readChunk();
        });
});

document.getElementById("usb-import-btn").addEventListener("click", function () {
    const statusDiv = document.getElementById("usb-import-status");
    statusDiv.innerHTML = "";
    fetch("/import_usb_progress")
        .then(response => {
            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");

            function readChunk() {
                reader.read().then(({ done, value }) => {
                    if (done) return;
                    const lines = decoder.decode(value, { stream: true }).split("\n");
                    lines.forEach(line => {
                        if (line.trim() !== "") {
                            displayStyledLine(statusDiv, line.trim());
                        }
                    });
                    readChunk();
                });
            }
            readChunk();
        });
});
     
</script>

</body>
</html>
